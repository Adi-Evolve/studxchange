<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sell Your Products - StudXchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Replace Leaflet with Google Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f4f6f9;
      color: #333;
      min-height: 100vh;
    }
  
    main {
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    
    .sell-container {
      display: flex;
      width: 100%;
      max-width: 1200px;
      gap: 20px;
    }
    
    .sell-page {
      flex: 1;
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .sell-page h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2a3d56;
    }
    
    .sell-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .form-column {
      flex: 1;
      min-width: 250px;
    }
    
    .sell-form label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      color: #2a3d56;
    }
    
    .sell-form input,
    .sell-form select,
    .sell-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .sell-form button {
      width: 100%;
      padding: 10px;
      background-color: #2a3d56;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .sell-form button:hover {
      background-color: #4d6a88;
    }
    
    /* Room specific styles */
    .room-form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .room-form-left, .room-form-right {
      flex: 1;
      min-width: 250px;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    
    .location-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .location-button {
   
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      background-color: #28a745;
      color: black;
    border: none;
    border-radius: 5px;
      padding: 10px;
    cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .location-button:hover {
      background-color: #218838;
    }
    
    .price-container {
        display: flex;
        gap: 10px;
      margin-bottom: 15px;
    }
    
    .price-container input {
      flex: 2;
    }
    
    .price-container select {
      flex: 1;
    }
    
    .image-preview-container {
      display: flex;
        flex-wrap: wrap;
      gap: 10px;
        margin-bottom: 15px;
    }

    .image-preview {
      width: 80px;
      height: 80px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }

    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-image {
        position: absolute;
        top: 2px;
        right: 2px;
        background: red;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }

    #imageUploadStatus {
        display: none;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    /* Keep existing modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto; /* Make modal scrollable */
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto; /* Reduced from 15% to 5% to show more content */
            padding: 20px;
      width: 80%;
            max-width: 400px;
      border-radius: 5px;
            text-align: center;
    }
    
    /* Map modal specific styles */
    #mapModal .modal-content {
      max-width: 800px;
      margin: 2% auto;
      height: auto; /* Changed from fixed height to auto */
      max-height: 90vh; /* Increased max height */
      overflow-y: auto; /* Make content scrollable */
    }
    
    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .pac-container {
      z-index: 1051 !important;
    }
    
    /* Add loading indicator for map */
    .map-loading {
      display: none;
      text-align: center;
      padding: 20px;
      font-weight: bold;
      color: #666;
    }

    .map-loading i {
      margin-right: 10px;
      color: #2a3d56;
    }
    
    .modal button {
            background-color: #2a3d56;
            color: white;
      padding: 10px 20px;
            border: none;
      border-radius: 5px;
            cursor: pointer;
      margin-top: 15px;
    }
    
    /* Keep existing navbar styles */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2a3d56;
      padding: 15px 30px;
      /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    }
    .navlogo img {
      height: 100px;
      width: 250px;
    }
    .navbar .button-container {
      display: flex;
      gap: 20px;
    }

    /* Search Bar Desktop */
    .search-container {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .searchbar {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 30px;
      padding: 2px;
      width: 100%;
      max-width: 600px;
    }
    .searchbar select,
    .searchbar input,
    .searchbar button {
      border: none;
      padding: 10px;
    }
    .searchbar select {
      background: #2a3d56;
      color: white;
      border-radius: 30px 0 0 30px;
    }
    .searchbar input {
      width: 100%;
    }
    .searchbar button {
      background: #2a3d56;
      color: white;
      border-radius: 0 30px 30px 0;
    }
    /* ===== Profile/Signup Button ===== */
    .button-container {
            display: flex;
      gap: 20px;
            align-items: center;
    }
    .profile-button, .signup-button {
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      transition: background 0.3s;
    }
    .profile-button {
      background: transparent;
    }
    .signup-button {
      background: #1a75ff;
      cursor: pointer;
    }
    .navbar a:hover {
      background-color: #4d6a88;
    }
    .navbar .button-container {
      display: flex;
      gap: 20px;
    }
    /* ===== Updated Button Styles ===== */
    .nav-button {
      padding: 10px 25px;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-weight: 500;
      display: inline-block;
    }
    /* Sell Button */
    .sell-button {
    color: white;
      background-color: transparent;
      border-color: transparent;
    }
    .sell-button:hover {
      background-color: #546e78;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Signup Button */
    .signup-button {
      color: white;
      background-color: transparent;
      border-color: transparent;
    }
    .signup-button:hover {
      background-color: #546e78;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Profile Button */
    .profile-button {
      color: white;
      background-color: #2a3d56;
      border-color: transparent;
    }
    .profile-button:hover {
      background-color: #1a2a3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Common Hover Effects */
    .nav-button:hover {
      border-color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
    }
    /* ===== Mobile Responsive Styles ===== */
    @media (max-width: 768px) {
      /* Navbar Mobile */
      .navbar {
        flex-direction: column;
        padding: 15px;
      }
      
      .navlogo img {
        height: 80px;
        width: 200px;
        margin-bottom: 15px;
      }
      
      .search-container {
        width: 100%;
    margin: 15px 0;
}

      .button-container {
        flex-direction: column;
        width: 100%;
        gap: 10px;
        margin-top: 15px;
      }
      
      /* Search Bar Mobile */
      .searchbar select {
        padding: 8px;
        font-size: 14px;
      }
      
      .searchbar input {
        font-size: 14px;
      }
      
      .searchbar button {
        padding: 2px;
      }
}
  </style>
  <script src="js/db-config.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <script src="js/firebase-config.js"></script>
  <script>
    // Check if the pdfs bucket exists, create it if it doesn't
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // List buckets to check if pdfs exists
        const { data: buckets, error } = await supabaseClient.storage.listBuckets();
        
        if (error) {
          console.error('Error checking buckets:', error);
          return;
        }
        
        // Check if pdfs bucket exists
        const pdfsBucketExists = buckets.some(bucket => bucket.name === 'pdfs');
        
        if (!pdfsBucketExists) {
          // Create the pdfs bucket
          const { error: createError } = await supabaseClient.storage.createBucket('pdfs', {
            public: true, // Make it publicly accessible
            fileSizeLimit: 104857600 // 100MB in bytes
          });
          
          if (createError) {
            console.error('Error creating pdfs bucket:', createError);
          } else {
            console.log('Created pdfs bucket successfully');
          }
        } else {
          console.log('pdfs bucket already exists');
        }
      } catch (err) {
        console.error('Error setting up storage:', err);
      }
    });
  </script>
</head>
<body>
  <!-- Common Navbar -->
  <header id="common-navbar"></header>
  
  <main>
    <div class="sell-container">
    <section class="sell-page">
      <h1>Sell Your Products</h1>
      
      <!-- Form Type Selection Tabs -->
      <div class="form-tabs">
        <button type="button" class="tab-button active" data-form="regularForm">Regular Products</button>
        <button type="button" class="tab-button" data-form="notesForm">Notes</button>
        <button type="button" class="tab-button" data-form="roomForm">Room/Hostel</button>
      </div>
      
      <!-- Common Fields For All Forms -->
      <div class="common-fields">
        <label for="college">Select College</label>
        <select id="college" name="college" required>
          <option value="all">All</option>
          <option value="VIT">Vishwakarma Institute of Technology</option>
          <option value="COEP">College Of Engineering</option>
          <option value="PICT">PICT, Balaji Nagar</option>
          <option value="DYP">D.Y.Patil Engineering College</option>
          <option value="PCCOE">Pimpri Chinchwad College of Engineering</option>
        </select>
      </div>
      
      <!-- Regular Products Form -->
      <form class="sell-form" id="regularProductForm">
        <h2><i class="fas fa-shopping-bag"></i> Sell Regular Products</h2>
        <div class="form-columns">
          <div class="form-column">
            <label for="category">Category</label>
            <select id="category" name="category" required>
              <option value="Laptop">Laptop</option>
              <option value="Books">Books</option>
              <option value="project equipments">Project Equipments</option>
              <option value="electronics">Electronics</option>
              <option value="Hostel Equipments">Hostel Equipments</option>
              <option value="stationery">Stationery</option>
              <option value="Vehicle">Cycle/Bike</option>
              <option value="others">Others</option>
            </select>
            
            <label for="title">Product Title</label>
            <input type="text" id="title" name="title" placeholder="e.g., Books, Scientific Calculator, Laptop" required>
            
            <label for="price">Set Price (₹)</label>
            <input type="number" id="price" name="price" placeholder="Enter price" required>
            
            <label for="condition">Condition</label>
            <select id="condition" name="condition" required>
              <option value="new">New</option>
              <option value="used">Used</option>
              <option value="refurbished">Refurbished</option>
            </select>
          </div>
          
          <div class="form-column">
            <label for="imageUpload">Upload Product Images (1-5)</label>
            <div class="image-preview-container" id="imagePreviews"></div>
            <input type="file" id="imageUpload" accept="image/*" multiple required>
            <div id="imageUploadStatus" aria-live="polite" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="uploadProgress">Uploading images...</span>
            </div>
            
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="5" placeholder="Write a detailed description of your product" required></textarea>
            
            <div id="locationSection">
              <button type="button" id="getLocationBtn" class="location-button">
                <i class="fas fa-map-marker-alt"></i> Use Current Location
              </button>
              <small id="locationStatus">Location not yet obtained</small>
            </div>
            
            <button type="submit" class="submit-button" id="regularSubmitBtn">
              <i class="fas fa-check-circle"></i> List Product
            </button>
          </div>
        </div>
      </form>
      
      <!-- Notes Form -->
      <form class="sell-form" id="notesForm" style="display: none;">
        <h2><i class="fas fa-file-alt"></i> Sell Notes</h2>
        <div class="form-columns">
          <div class="form-column">
            <label for="notesTitle">Title of Notes</label>
            <input type="text" id="notesTitle" name="notesTitle" placeholder="Enter title of notes" required>
            
            <label for="notesSubject">Subject</label>
            <input type="text" id="notesSubject" name="notesSubject" placeholder="e.g., Physics, Mathematics, Computer Science" required>
            
            <label for="notesSemester">Semester/Year</label>
            <select id="notesSemester" name="notesSemester" required>
              <option value="">Select Semester/Year</option>
              <option value="1st Semester">1st Semester</option>
              <option value="2nd Semester">2nd Semester</option>
              <option value="3rd Semester">3rd Semester</option>
              <option value="4th Semester">4th Semester</option>
              <option value="5th Semester">5th Semester</option>
              <option value="6th Semester">6th Semester</option>
              <option value="7th Semester">7th Semester</option>
              <option value="8th Semester">8th Semester</option>
              <option value="1st Year">1st Year</option>
              <option value="2nd Year">2nd Year</option>
              <option value="3rd Year">3rd Year</option>
              <option value="4th Year">4th Year</option>
            </select>
            
            <label for="notesPrice">Price (₹)</label>
            <div class="price-container">
              <input type="number" id="notesPrice" name="notesPrice" placeholder="Enter price" required>
              <small style="display: block; color: #666; margin-top: 5px;">Note: ₹5 will be deducted as platform fees</small>
            </div>
          </div>
          
          <div class="form-column">
            <label for="notesImageUpload">Upload Preview Images (1-5)</label>
            <div class="image-preview-container" id="notesImagePreviews"></div>
            <input type="file" id="notesImageUpload" accept="image/*" multiple required>
            <small>Upload preview images of your notes</small>
            <div id="notesImageUploadStatus" aria-live="polite" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="notesUploadProgress">Uploading images...</span>
            </div>
            
            <label for="pdfFileInput">Upload PDF (max 100MB):</label>
            <input type="file" id="pdfFileInput" name="pdfFileInput" accept="application/pdf" required />
            <div id="notesPdfUploadStatus" aria-live="polite" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="pdfUploadProgress">Uploading PDF...</span>
            </div>
            
            <label for="notesDescription">Description</label>
            <textarea id="notesDescription" name="notesDescription" rows="5" placeholder="Write a detailed description of your notes" required></textarea>
            
            <button type="submit" class="submit-button" id="notesSubmitBtn">
              <i class="fas fa-check-circle"></i> List Notes
            </button>
          </div>
        </div>
      </form>
      
      <!-- Room/Hostel Form -->
      <form class="sell-form" id="roomForm" style="display: none;">
        <h2><i class="fas fa-home"></i> List Room/Hostel</h2>
        <div class="form-columns">
          <div class="form-column">
            <label for="roomTitle">Title</label>
            <input type="text" id="roomTitle" name="roomTitle" placeholder="e.g., Single Room near VIT" required>
            
            <label for="roomType">Type</label>
            <select id="roomType" name="roomType" required>
              <option value="">Select Room Type</option>
              <option value="Single Room">Single Room</option>
              <option value="Shared Room">Shared Room</option>
              <option value="1BHK">1BHK</option>
              <option value="2BHK">2BHK</option>
              <option value="3BHK">3BHK</option>
              <option value="PG">PG</option>
              <option value="Hostel">Hostel</option>
            </select>
            
            <label for="roomRent">Monthly Rent (₹)</label>
            <input type="number" id="roomRent" name="roomRent" placeholder="Enter monthly rent" required>
            
            <label for="depositAmount">Deposit Amount (₹)</label>
            <input type="number" id="depositAmount" name="depositAmount" placeholder="Enter deposit amount" required>
            
            <label for="roomDescription">Description</label>
            <textarea id="roomDescription" name="roomDescription" rows="5" placeholder="Write a detailed description of the room/hostel" required></textarea>
            
            <label for="collegeDistance">Distance from College (km)</label>
            <input type="number" id="collegeDistance" name="collegeDistance" placeholder="Enter distance in kilometers" step="0.1">
            
            <label for="occupancy">Occupancy</label>
            <input type="number" id="occupancy" name="occupancy" placeholder="Number of people" min="1">
          </div>
          
          <div class="form-column">
            <label for="roomImageUpload">Upload Room Images (up to 10)</label>
            <div class="image-preview-container" id="roomImagePreviews"></div>
            <input type="file" id="roomImageUpload" accept="image/*" multiple required>
            <small>Maximum 50MB total</small>
            <div id="roomImageUploadStatus" aria-live="polite" style="display: none;">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="roomUploadProgress">Uploading images...</span>
            </div>
            
            <label for="ownerName">Owner Name</label>
            <input type="text" id="ownerName" name="ownerName" placeholder="Enter owner name" required>
            
            <label for="contact1">Contact Number 1</label>
            <input type="tel" id="contact1" name="contact1" placeholder="Enter primary contact number" pattern="[0-9]{10}" required>
            
            <label for="contact2">Contact Number 2 (Optional)</label>
            <input type="tel" id="contact2" name="contact2" placeholder="Enter secondary contact number" pattern="[0-9]{10}">
            
            <label>Amenities</label>
            <div class="amenities-container">
                  <div class="checkbox-item">
                    <input type="checkbox" id="ac" name="amenities" value="ac">
                    <label for="ac">AC</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="wifi" name="amenities" value="wifi">
                    <label for="wifi">WiFi</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="washingMachine" name="amenities" value="washingMachine">
                    <label for="washingMachine">Washing Machine</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="mess" name="amenities" value="mess">
                    <label for="mess">Mess Included</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="fridge" name="amenities" value="fridge">
                    <label for="fridge">Refrigerator</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="parking" name="amenities" value="parking">
                    <label for="parking">Parking</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="geyser" name="amenities" value="geyser">
                    <label for="geyser">Hot Water/Geyser</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="furnished" name="amenities" value="furnished">
                    <label for="furnished">Furnished</label>
                  </div>
                </div>
                
                <div id="messSection">
                  <label for="messType">Mess Type</label>
                  <select id="messType" name="messType">
                    <option value="">Select Mess Type</option>
                    <option value="Veg">Veg</option>
                    <option value="Non-Veg">Non-Veg</option>
                    <option value="Both">Both</option>
                  </select>
                </div>
                
                <div class="location-buttons">
                  <button type="button" id="currentLocationBtn" class="location-button">
                    <i class="fas fa-map-marker-alt"></i> Current Location
                  </button>
                  <button type="button" id="mapLocationBtn" class="location-button">
                    <i class="fas fa-map"></i> Select on Map
                  </button>
                </div>
                <small id="roomLocationStatus">Location not yet obtained</small>
                
                <button type="submit" class="submit-button" id="roomSubmitBtn">
                  <i class="fas fa-check-circle"></i> List Room/Hostel
                </button>
                
                <div class="checkbox-item">
                  <input type="checkbox" id="installment" name="installment">
                  <label for="installment">Installment Option Available</label>
                </div>
              </div>
            </div>
          </div>
        </form>
      </section>
    </div>
  </main>
  
        <div id="phoneErrorModal" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closePhoneErrorModal()">&times;</span>
              <h2>Phone Number Required</h2>
              <p>You need to add a phone number to list items for sale.</p>
              <button onclick="redirectToProfile()">Add Phone Number</button>
          </div>
      </div>
  
  <!-- Google Maps Modal -->
  <!-- Update map modal content -->
<div id="mapModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeMapModal()">&times;</span>
    <h2>Select Location</h2>
    <div style="margin-bottom: 10px;">
      <div id="mapSearchContainer" style="display: flex; gap: 10px;">
        <input type="text" id="mapSearchInput" placeholder="Search for a location" style="flex: 1; padding: 8px;">
        <button onclick="searchLocation()" style="padding: 8px 15px;">Search</button>
      </div>
    </div>
    <div id="mapLoading" class="map-loading">
      <i class="fas fa-spinner fa-spin"></i> Loading map...
    </div>
    <div id="map" style="height: 500px;"></div>
    <div style="margin-top: 15px;">
      <div id="selectedLocationDisplay" style="margin-bottom: 10px; padding: 8px; background: #f4f4f4; border-radius: 4px;">
        No location selected
      </div>
      <button onclick="confirmMapLocation()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px;">
        Confirm Location
      </button>
    </div>
  </div>
</div>

  
<script src="js/navbar.js"></script>
<script>
  // Global variables for map and user location
  let map;
  let marker;
  let geocoder;
  let userCoordinates = null;
  let userLocationName = '';

  // -----------------------------
  // Map Functions using Leaflet
  // -----------------------------
  function initMap() {
    // Default center (Pune)
    const defaultCenter = [18.5204, 73.8567];
    
    map = L.map('map').setView(defaultCenter, 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Initialize geocoder control
    geocoder = L.Control.geocoder({
      defaultMarkGeocode: false,
      collapsed: false
    }).addTo(map);

    // When a geocode result is chosen, update the map
    geocoder.on('markgeocode', function(e) {
      const center = e.geocode.center;
      updateMapLocation(center.lat, center.lng, e.geocode.name);
    });

    // Initialize marker at default center and make it draggable
    marker = L.marker(defaultCenter, {draggable: true}).addTo(map);
    
    // When marker is dragged, update location
    marker.on('dragend', function(e) {
      const position = marker.getLatLng();
      updateMapLocation(position.lat, position.lng);
      reverseGeocode(position.lat, position.lng);
    });

    // Allow users to click on the map to set the marker
    map.on('click', function(e) {
      marker.setLatLng(e.latlng);
      updateMapLocation(e.latlng.lat, e.latlng.lng);
      reverseGeocode(e.latlng.lat, e.latlng.lng);
    });

    // Hide loading indicator once map is ready
    document.getElementById('mapLoading').style.display = 'none';
  }

  async function reverseGeocode(lat, lng) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      const data = await response.json();
      userLocationName = data.display_name;
      document.getElementById('selectedLocationDisplay').textContent = userLocationName;
    } catch (error) {
      console.error('Reverse geocoding error:', error);
      document.getElementById('selectedLocationDisplay').textContent =
        `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
    }
  }

  function updateMapLocation(lat, lng, name = '') {
    userCoordinates = { lat, lon: lng };
    if (name) userLocationName = name;
    document.getElementById('selectedLocationDisplay').textContent = name ||
      `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
  }

  function searchLocation() {
    const query = document.getElementById('mapSearchInput').value;
    if (!query) return;

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          const result = data[0];
          map.setView([result.lat, result.lon], 16);
          marker.setLatLng([result.lat, result.lon]);
          updateMapLocation(parseFloat(result.lat), parseFloat(result.lon), result.display_name);
        }
      });
  }

  function openMapModal() {
    document.getElementById('mapModal').style.display = 'block';
    if (!map) {
      initMap();
    } else {
      map.invalidateSize();
    }
  }

  function closeMapModal() {
    document.getElementById('mapModal').style.display = 'none';
  }

  function confirmMapLocation() {
    if (!userCoordinates) {
      alert('Please select a location on the map first.');
      return;
    }
    
    // Determine which location status to update based on the category
    const isRoom = document.getElementById('category').value === 'Room';
    const locationStatus = document.getElementById(isRoom ? 'roomLocationStatus' : 'locationStatus');
    locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${userLocationName || 'Location selected'}`;
    locationStatus.style.color = '#28a745';
    
    closeMapModal();
  }

  // -----------------------------
  // Tabbed Interface Handling
  // -----------------------------
  function setupTabButtons() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const forms = {
      'regularForm': document.getElementById('regularProductForm'),
      'notesForm': document.getElementById('notesForm'),
      'roomForm': document.getElementById('roomForm')
    };
    
    // Function to switch active tab and form
    function switchTab(activeFormId) {
      // Hide all forms
      Object.values(forms).forEach(form => {
        if (form) form.style.display = 'none';
      });
      
      // Remove active class from all tabs
      tabButtons.forEach(btn => btn.classList.remove('active'));
      
      // Show the selected form and activate its tab
      if (forms[activeFormId]) {
        forms[activeFormId].style.display = 'block';
        document.querySelector(`.tab-button[data-form="${activeFormId}"]`).classList.add('active');
      }
    }
    
    // Add click event listeners to all tab buttons
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const formId = this.getAttribute('data-form');
        switchTab(formId);
      });
    });
    
    return switchTab; // Return the function for external use
  }
  
  // -----------------------------
  // Form and Image Upload Handling
  // -----------------------------
  document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
      alert('Please log in to sell or donate items.');
      window.location.href = 'login.html';
      return;
    }
    
    // Initialize the form and state
    initForm();
    
    // Setup tab switching functionality
    const switchTab = setupTabButtons();
    
    // Show only the appropriate form based on the URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get('type');
    
    if (formType) {
      // Switch to the appropriate form based on URL parameter
      if (formType === 'notes') {
        switchTab('notesForm');
      } else if (formType === 'room' || formType === 'hostel') {
        switchTab('roomForm');
      } else {
        switchTab('regularForm');
      }
    } else {
      // Default to regular product form
      switchTab('regularForm');
    }
    
    // Set up checkbox behavior for mess section
    const messCheckbox = document.getElementById('mess');
    const messSection = document.getElementById('messSection');
    
    if (messCheckbox && messSection) {
      messCheckbox.addEventListener('change', function() {
        messSection.style.display = this.checked ? 'block' : 'none';
      });
      
      // Initialize state
      messSection.style.display = messCheckbox.checked ? 'block' : 'none';
    }
    
    // Trigger category change event to set the initial form state
    const event = new Event('change');
    document.getElementById('category').dispatchEvent(event);
  });

  function initForm() {
    // Variables for image handling
    let uploadedImages = [];
    let imageUrls = [];
    
    // ImgBB Configuration
    const IMGBB_API_KEY = '272785e1c6e6221d927bad99483ff9ed';
    const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';

    // Toggle between regular and room forms based on category selection
    document.getElementById('category').addEventListener('change', function() {
      const selectedCategory = this.value;
      const isRoom = selectedCategory === 'Room';
      const isNotes = selectedCategory === 'Notes';
      
      // Toggle display of form sections
      document.getElementById('regularForm').style.display = (isRoom || isNotes) ? 'none' : 'block';
      document.getElementById('regularFormCont').style.display = (isRoom || isNotes) ? 'none' : 'block';
      document.getElementById('roomForm').style.display = isRoom ? 'block' : 'none';
      document.getElementById('notesForm').style.display = isNotes ? 'block' : 'none';
      
      // Reset form fields when switching
      if (isRoom) {
        // Clear regular product fields
        document.getElementById('title').value = '';
        document.getElementById('price').value = '';
        document.getElementById('description').value = '';
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreviews').innerHTML = '';
      } else if (isNotes) {
        // Clear regular product fields
        document.getElementById('title').value = '';
        document.getElementById('price').value = '';
        document.getElementById('description').value = '';
        document.getElementById('imageUpload').value = '';
        document.getElementById('imagePreviews').innerHTML = '';
      } else {
        // Clear room-specific fields
        document.getElementById('hostelName').value = '';
        document.getElementById('ownerName').value = '';
        document.getElementById('contact1').value = '';
        document.getElementById('contact2').value = '';
        document.getElementById('collegeDistance').value = '';
        document.getElementById('occupancy').value = '';
        document.getElementById('roomPrice').value = '';
        document.getElementById('roomImageUpload').value = '';
        document.getElementById('roomImagePreviews').innerHTML = '';
        
        // Reset checkboxes
        document.getElementById('ac').checked = false;
        document.getElementById('wifi').checked = false;
        document.getElementById('washingMachine').checked = false;
        document.getElementById('mess').checked = false;
        document.getElementById('installment').checked = false;
        
        // Clear notes-specific fields
        document.getElementById('notesTitle').value = '';
        document.getElementById('notesDescription').value = '';
        document.getElementById('notesPrice').value = '';
        document.getElementById('notesImageUpload').value = '';
        document.getElementById('notesPdfUpload').value = '';
        document.getElementById('notesImagePreviews').innerHTML = '';
      }
      
      // Toggle required attributes for regular product fields
      const regularFields = ['title', 'price', 'condition', 'description', 'imageUpload'];
      regularFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
          if (isRoom || isNotes) {
            element.removeAttribute('required');
          } else {
            element.setAttribute('required', 'required');
          }
        }
      });
      
      // Toggle required attributes for room fields
      const roomFields = ['hostelName', 'roomPrice', 'contact1', 'roomImageUpload'];
      roomFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
          if (isRoom) {
            element.setAttribute('required', 'required');
          } else {
            element.removeAttribute('required');
          }
        }
      });
    });
    
    // Toggle mess price input based on mess checkbox
    document.getElementById('mess').addEventListener('change', function() {
      document.getElementById('messSection').style.display = this.checked ? 'block' : 'none';
    });
    
    // Location handling for regular products using Geolocation API
    async function getAddressFromCoords(lat, lon) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&email=your@email.com`
        );
        const data = await response.json();
        return data.display_name || 'Location obtained';
      } catch (error) {
        console.error('Reverse geocoding error:', error);
        return 'Approximate location';
      }
    }

    document.getElementById('getLocationBtn').addEventListener('click', async () => {
      try {
        document.getElementById('locationStatus').textContent = 'Getting location...';
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        userCoordinates = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };
        
        userLocationName = await getAddressFromCoords(userCoordinates.lat, userCoordinates.lon);
        
        // Update the location status with an icon and the address
        const locationStatus = document.getElementById('locationStatus');
        locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${userLocationName}`;
        locationStatus.style.color = '#28a745';
      } catch (error) {
        console.error('Location error:', error);
        document.getElementById('locationStatus').textContent = 'Failed to get location';
        document.getElementById('locationStatus').style.color = '#dc3545';
      }
    });
    
    // Location handling for room listings (current location)
    document.getElementById('currentLocationBtn').addEventListener('click', async () => {
      try {
        document.getElementById('roomLocationStatus').textContent = 'Getting location...';
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        userCoordinates = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };
        
        userLocationName = await getAddressFromCoords(userCoordinates.lat, userCoordinates.lon);
        
        const locationStatus = document.getElementById('roomLocationStatus');
        locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${userLocationName}`;
        locationStatus.style.color = '#28a745';
      } catch (error) {
        console.error('Location error:', error);
        document.getElementById('roomLocationStatus').textContent = 'Failed to get location';
        document.getElementById('roomLocationStatus').style.color = '#dc3545';
      }
    });
    
    // Open map modal for room listings
    document.getElementById('mapLocationBtn').addEventListener('click', openMapModal);
    

    
    // ---------------
    // Image Uploads
    // ---------------
    async function uploadImages(isRoom = false) {
      const fileInput = isRoom ? document.getElementById('roomImageUpload') : document.getElementById('imageUpload');
      const files = Array.from(fileInput.files);
      
      if (files.length === 0) throw new Error('No images selected');
      if (!isRoom && files.length > 5) throw new Error('Maximum 5 images allowed');
      if (isRoom && files.length > 10) throw new Error('Maximum 10 images allowed');

      const statusElement = isRoom ? document.getElementById('roomImageUploadStatus') : document.getElementById('imageUploadStatus');
      const progressElement = isRoom ? document.getElementById('roomUploadProgress') : document.getElementById('uploadProgress');
      const uploadedUrls = [];

      // For room images, check total file size (max 50MB)
      if (isRoom) {
        const totalSize = files.reduce((sum, file) => sum + file.size, 0);
        const MAX_SIZE = 50 * 1024 * 1024; // 50MB
        if (totalSize > MAX_SIZE) {
          throw new Error('Total file size exceeds 50MB limit');
        }
      }

      try {
        statusElement.style.display = 'flex';
        
        for (let i = 0; i < files.length; i++) {
          progressElement.textContent = `Uploading images (${i+1}/${files.length})...`;
          
          const formData = new FormData();
          formData.append('image', files[i]);

          const response = await fetch(`${IMGBB_UPLOAD_URL}?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          if (!data.success) throw new Error(data.error.message || 'Image upload failed');
          uploadedUrls.push(data.data.url);
        }

        return uploadedUrls;
      } catch (error) {
        console.error("Image upload error:", error);
        throw new Error('Image upload failed: ' + error.message);
      } finally {
        statusElement.style.display = 'none';
      }
    }
    
    // Preview for regular product images
    document.getElementById('imageUpload').addEventListener('change', function(e) {
      const previewContainer = document.getElementById('imagePreviews');
      previewContainer.innerHTML = '';
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const invalidFiles = Array.from(this.files).filter(file => !allowedTypes.includes(file.type));
      
      if (invalidFiles.length > 0) {
        alert('Only JPG, PNG, and WEBP images are allowed');
        this.value = '';
        return;
      }
      
      if (this.files.length > 5) {
        alert('Maximum 5 images allowed');
        this.value = '';
        return;
      }

      Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview ${index + 1}">
            <div class="remove-image" onclick="removeImage(${index}, false)">×</div>
          `;
          previewContainer.appendChild(preview);
        }
        reader.readAsDataURL(file);
      });
    });
    

    
    // Preview for room images
    document.getElementById('roomImageUpload').addEventListener('change', function(e) {
      const previewContainer = document.getElementById('roomImagePreviews');
      previewContainer.innerHTML = '';
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const invalidFiles = Array.from(this.files).filter(file => !allowedTypes.includes(file.type));
      
      if (invalidFiles.length > 0) {
        alert('Only JPG, PNG, and WEBP images are allowed');
        this.value = '';
        return;
      }
      
      if (this.files.length > 10) {
        alert('Maximum 10 images allowed');
        this.value = '';
        return;
      }
      
      // Check total size of room images
      const totalSize = Array.from(this.files).reduce((sum, file) => sum + file.size, 0);
      const MAX_SIZE = 50 * 1024 * 1024; // 50MB
      if (totalSize > MAX_SIZE) {
        alert('Total file size exceeds 50MB limit');
        this.value = '';
        return;
      }

      Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview ${index + 1}">
            <div class="remove-image" onclick="removeImage(${index}, true)">×</div>
          `;
          previewContainer.appendChild(preview);
        }
        reader.readAsDataURL(file);
      });
    });
    
    // Remove image function used in both cases
    window.removeImage = function(index, isRoom) {
      try {
        const fileInputId = isRoom ? 'roomImageUpload' : 'imageUpload';
        const files = Array.from(document.getElementById(fileInputId).files);
        files.splice(index, 1);
        
        if (typeof DataTransfer === 'undefined') {
          console.error("DataTransfer API not available");
          alert("Your browser doesn't support image removal. Please try uploading all images at once.");
          return;
        }
        
        const newFiles = new DataTransfer();
        files.forEach(file => newFiles.items.add(file));
        document.getElementById(fileInputId).files = newFiles.files;
        
        // Update previews by triggering change event
        document.getElementById(fileInputId).dispatchEvent(new Event('change'));
      } catch (error) {
        console.error("Error removing image:", error);
        alert("Failed to remove image. Please try uploading all images at once.");
      }
    };

    // -----------------------------
    // Form Submission
    // -----------------------------
    document.getElementById('sellForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      console.log("Form submission started");

      // Get the PDF file from your existing input
      const pdfInput = document.getElementById('pdfFileInput');
      const pdfFile = pdfInput && pdfInput.files.length > 0 ? pdfInput.files[0] : null;
      let pdfUrl = '';
      if (pdfFile) {
        // Only allow PDF up to 100MB
        if (pdfFile.size > 100 * 1024 * 1024) {
          alert('PDF must be less than 100MB');
          return;
        }
        // Upload PDF to Cloudinary
        document.getElementById('notesPdfUploadStatus').style.display = 'flex';
        document.getElementById('pdfUploadProgress').textContent = 'Uploading PDF...';
        const formData = new FormData();
        formData.append('file', pdfFile);
        formData.append('upload_preset', 'studx_pdf_upload'); // <-- use your unsigned preset
        try {
          const response = await fetch('https://api.cloudinary.com/v1_1/djouqnug2/auto/upload', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (data.secure_url) {
            pdfUrl = data.secure_url;
            document.getElementById('pdfUploadProgress').textContent = 'PDF uploaded successfully!';
          } else {
            alert('PDF upload failed');
            document.getElementById('pdfUploadProgress').textContent = 'PDF upload failed';
            return;
          }
        } catch (err) {
          alert('PDF upload failed: ' + err.message);
          document.getElementById('pdfUploadProgress').textContent = 'PDF upload failed';
          return;
        } finally {
          setTimeout(() => {
            document.getElementById('notesPdfUploadStatus').style.display = 'none';
          }, 3000);
        }
      }
      // Add pdfUrl as a hidden input so it gets submitted with the form
      if (pdfUrl) {
        let hidden = document.getElementById('pdfUrlHidden');
        const form = document.querySelector('form');
        if (!hidden) {
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'pdfUrl';
          hidden.id = 'pdfUrlHidden';
          form.appendChild(hidden);
        }
        hidden.value = pdfUrl;
      }

      try {
        // Verify API endpoints exist
        if (typeof API_ENDPOINTS === 'undefined' || !API_ENDPOINTS.ADD_PRODUCT || !API_ENDPOINTS.ADD_ROOM) {
          console.error("API endpoints not defined");
          alert("Error: API configuration not loaded. Please refresh the page and try again.");
          return;
        }
        
        // Ensure location is provided for regular products and rooms, but not for notes
        const category = document.getElementById('category').value;
        if (category !== 'Notes' && !userCoordinates) {
          alert("Please provide your location to continue.");
          console.log("Location not provided");
          return;
        }
        
        // Check that the current user has a phone number
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || !currentUser.phone) {
          document.getElementById('phoneErrorModal').style.display = 'block';
          console.log("Phone number not provided");
          return;
        }
        
        // const category = document.getElementById('category').value;
        // console.log("Form type:", category);
        
        // Common field: college selection
        const college = document.getElementById('college').value;
        
        if (category === 'Room') {
          // Process room listing
          console.log("Processing room listing");
          const hostelName = document.getElementById('hostelName').value;
          if (!hostelName) {
            alert("Please enter a hostel/PG name");
            return;
          }
          
          const roomPrice = document.getElementById('roomPrice').value;
          if (!roomPrice) {
            alert("Please enter a price");
            return;
          }
          
          // Validate room images
          const roomImages = document.getElementById('roomImageUpload').files;
          if (roomImages.length === 0) {
            alert("Please upload at least one image");
            return;
          }
          
          if (roomImages.length > 10) {
            alert("You can upload a maximum of 10 images");
            return;
          }
          
          document.getElementById('roomImageUploadStatus').style.display = 'flex';
          console.log("Uploading room images...");
          const uploadedRoomImages = await uploadImages(true);
          console.log("Room images uploaded:", uploadedRoomImages);
          
          // Create room object to send to the API
          const room = {
            college,
            title: hostelName,
            category,
            hostelName,
            ownerName: document.getElementById('ownerName').value,
            contact1: document.getElementById('contact1').value,
            contact2: document.getElementById('contact2').value || null,
            images: uploadedRoomImages,
            coordinates: userCoordinates,
            location: userLocationName,
            collegeDistance: parseFloat(document.getElementById('collegeDistance').value) || null,
            occupancy: parseInt(document.getElementById('occupancy').value) || null,
            amenities: Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value),
            hasAC: document.getElementById('ac').checked,
            hasWifi: document.getElementById('wifi').checked,
            hasWashingMachine: document.getElementById('washingMachine').checked,
            hasMess: document.getElementById('mess').checked,
            messPrice: document.getElementById('mess').checked ? parseFloat(document.getElementById('messPrice').value) || null : null,
            hasInstallment: document.getElementById('installment').checked,
            price: roomPrice,
            priceType: document.getElementById('priceType').value,
            sellerPhone: currentUser.phone,
            sellerEmail: currentUser.email
          };
          
          console.log("Submitting room data:", room);
          
          const response = await fetch(API_ENDPOINTS.ADD_ROOM, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(room)
          });
          
          console.log("Room submission response status:", response.status);
          
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Room submission error:", errorData);
            throw new Error(errorData.message || 'Failed to save room listing');
          }
          
          const responseData = await response.json();
          console.log("Room submission successful:", responseData);
          
          alert('Room listed successfully!');
          window.location.href = 'index.html';
        } else if (category === 'Notes') {
          // Process notes listing
          console.log("Processing notes listing");
          
          // Validate notes title
          const notesTitle = document.getElementById('notesTitle').value;
          if (!notesTitle) {
            alert("Please enter a title for your notes");
            return;
          }
          
          // Validate notes price
          const notesPrice = document.getElementById('notesPrice').value;
          if (!notesPrice) {
            alert("Please enter a price for your notes");
            return;
          }
          
          // Validate notes description
          const notesDescription = document.getElementById('notesDescription').value;
          if (!notesDescription) {
            alert("Please enter a description for your notes");
            return;
          }
          
          // Validate notes images
          const notesImages = document.getElementById('notesImageUpload').files;
          if (notesImages.length === 0) {
            alert("Please upload at least one image of your notes");
            return;
          }
          
          if (notesImages.length > 5) {
            alert("You can upload a maximum of 5 images");
            return;
          }
          
          // Validate PDF file
          const pdfInput = document.getElementById('pdfFileInput');
          const pdfFile = pdfInput && pdfInput.files.length > 0 ? pdfInput.files[0] : null;
          if (!pdfFile) {
            alert("Please upload your notes in PDF format");
            return;
          }
          if (pdfFile.size > 100 * 1024 * 1024) {
            alert('PDF must be less than 100MB');
            return;
          }
          
          // Show upload status
          document.getElementById('notesImageUploadStatus').style.display = 'flex';
          
          // Upload images
          console.log("Uploading notes images...");
          const notesImageUrls = await uploadNotesImages();
          console.log("Notes images uploaded:", notesImageUrls);
          
          // Upload PDF to Cloudinary
          console.log("Uploading PDF to Cloudinary...");
          const pdfUrl = await uploadPdfToCloudinary(pdfFile);
          console.log("PDF uploaded to Cloudinary:", pdfUrl);
          
          // Create notes object (without location)
          const notes = {
            college,
            title: notesTitle,
            category,
            price: notesPrice,
            images: notesImageUrls,
            description: notesDescription,
            condition: 'new', // Default for notes
            pdfUrl, // Cloudinary URL
            sellerPhone: currentUser.phone,
            sellerEmail: currentUser.email,
            createdAt: new Date().toISOString()
          };
          
          console.log("Submitting notes:", notes);
          
          // Add notes to database
          const response = await fetch(API_ENDPOINTS.ADD_NOTES, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(notes)
          });
          
          console.log("Notes submission response status:", response.status);
          
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Notes submission error:", errorData);
            throw new Error(errorData.message || 'Failed to save notes');
          }
          
          const responseData = await response.json();
          console.log("Notes submission successful:", responseData);
          
          alert('Notes listed successfully!');
          window.location.href = 'index.html';
        } else {
          // Process regular product listing
          console.log("Processing regular product listing");
          const files = document.getElementById('imageUpload').files;
          if (files.length < 1) {
            alert('Please select at least 1 image');
            return;
          }
          
          if (files.length > 5) {
            alert('Maximum 5 images allowed');
            return;
          }
          
          const title = document.getElementById('title').value;
          const price = document.getElementById('price').value;
          const description = document.getElementById('description').value;
          
          if (!title || !price || !description) {
            alert('Please fill in all required fields');
            return;
          }

          document.getElementById('imageUploadStatus').style.display = 'flex';
          console.log("Uploading product images...");
          const imageUrls = await uploadImages(false);
          console.log("Product images uploaded:", imageUrls);
          
          const product = {
            college: document.getElementById('college').value,
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            price: document.getElementById('price').value,
            images: imageUrls,
            description: document.getElementById('description').value,
            condition: document.getElementById('condition').value,
            sellerPhone: currentUser.phone,
            sellerEmail: currentUser.email,
            createdAt: new Date().toISOString(),
            location: userLocationName,
            coordinates: userCoordinates
          };

          console.log('Submitting product:', product);

          const response = await fetch(API_ENDPOINTS.ADD_PRODUCT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product)
          });

          console.log("Product submission response status:", response.status);
          
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Product submission error:", errorData);
            throw new Error(errorData.message || 'Failed to save product');
          }
          
          const responseData = await response.json();
          console.log("Product submission successful:", responseData);
          
          alert('Product listed successfully!');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error("Form submission error:", error);
        alert(error.message || 'Failed to submit listing');
      } finally {
        document.getElementById('imageUploadStatus').style.display = 'none';
        document.getElementById('roomImageUploadStatus').style.display = 'none';
        document.getElementById('notesImageUploadStatus').style.display = 'none';
        document.getElementById('notesPdfUploadStatus').style.display = 'none';
      }
    });

    // -----------------------------
    // Modal Functions
    // -----------------------------
    function redirectToProfile() {
      window.location.href = 'PROFILE_FINAL.html';
    }

    function closePhoneErrorModal() {
      document.getElementById('phoneErrorModal').style.display = 'none';
    }

    // Initialize form state from draft if available
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Initializing form state");
      
      document.getElementById('roomForm').style.display = 'none';
      
      // Remove required attributes from room fields initially
      document.getElementById('roomPrice').removeAttribute('required');
      document.getElementById('roomImageUpload').removeAttribute('required');
      
      const draftData = JSON.parse(localStorage.getItem('draftListing'));
      if (draftData) {
        document.getElementById('college').value = draftData.college || '';
        document.getElementById('category').value = draftData.category || '';
        
        const event = new Event('change');
        document.getElementById('category').dispatchEvent(event);
        
        if (draftData.category === 'Room') {
          document.getElementById('hostelName').value = draftData.hostelName || '';
          document.getElementById('ownerName').value = draftData.ownerName || '';
          document.getElementById('contact1').value = draftData.contact1 || '';
          document.getElementById('contact2').value = draftData.contact2 || '';
          document.getElementById('collegeDistance').value = draftData.collegeDistance || '';
          document.getElementById('occupancy').value = draftData.occupancy || '';
          document.getElementById('roomPrice').value = draftData.price || '';
          document.getElementById('priceType').value = draftData.priceType || 'monthly';
          
          if (draftData.hasAC) document.getElementById('ac').checked = true;
          if (draftData.hasWifi) document.getElementById('wifi').checked = true;
          if (draftData.hasWashingMachine) document.getElementById('washingMachine').checked = true;
          if (draftData.hasMess) {
            document.getElementById('mess').checked = true;
            document.getElementById('messSection').style.display = 'block';
            document.getElementById('messPrice').value = draftData.messPrice || '';
          }
          if (draftData.hasInstallment) document.getElementById('installment').checked = true;
        } else {
          document.getElementById('title').value = draftData.title || '';
          document.getElementById('price').value = draftData.price || '';
          document.getElementById('condition').value = draftData.condition || 'used';
          document.getElementById('description').value = draftData.description || '';
        }
        
        if (draftData.coordinates) {
          userCoordinates = draftData.coordinates;
          userLocationName = draftData.location || '';
          
          const locationStatus = document.getElementById(draftData.category === 'Room' ? 'roomLocationStatus' : 'locationStatus');
          locationStatus.textContent = userLocationName;
          locationStatus.style.color = '#28a745';
        }
      }
      
      console.log("Form initialized successfully");
    });

    // Removed notesLocationBtn event listener as location is no longer required for notes
    
    // Add handler for notes location
    document.getElementById('getLocationBtn').addEventListener('click', getLocation);
    
    // Supabase Storage integration for PDF uploads (supports up to 100MB)
    // Optimized for Vercel deployment - bypasses serverless functions
    async function uploadPdfToCloudinary(file) {
      try {
        // Show upload status
        document.getElementById('notesPdfUploadStatus').style.display = 'flex';
        document.getElementById('pdfUploadProgress').textContent = 'Preparing PDF upload...';
        
        // Check file size
        if (file.size > SUPABASE_MAX_FILE_SIZE) {
          throw new Error(`File size exceeds the maximum limit of ${SUPABASE_MAX_FILE_SIZE / (1024 * 1024)}MB`);
        }
        
        // Create a unique filename with timestamp to prevent collisions
        const timestamp = Date.now();
        const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9.-]/g, '_'); // Remove special characters
        const filename = `${timestamp}_${sanitizedFilename}`;
        
        // Upload directly to Supabase Storage (client-side)
        document.getElementById('pdfUploadProgress').textContent = 'Uploading PDF to storage...';
        
        // Use chunked upload for large files to improve reliability
        const chunkSize = 2 * 1024 * 1024; // 2MB chunks to avoid Vercel limits
        const totalChunks = Math.ceil(file.size / chunkSize);
        
        // For files under 4MB, upload directly
        if (file.size <= 4 * 1024 * 1024) {
          const { data, error } = await supabaseClient
            .storage
            .from('pdfs')
            .upload(filename, file, {
              cacheControl: '3600',
              upsert: true
            });
          
          if (error) {
            throw error;
          }
          
          // Get the public URL
          const { data: urlData } = supabaseClient
            .storage
            .from('pdfs')
            .getPublicUrl(filename);
          
          document.getElementById('pdfUploadProgress').textContent = 'PDF uploaded successfully!';
          
          // Hide status after a delay
          setTimeout(() => {
            document.getElementById('notesPdfUploadStatus').style.display = 'none';
          }, 3000);
          
          return urlData.publicUrl;
        } 
        // For larger files, use chunk upload strategy
        else {
          // Create upload progress tracking
          let uploadedChunks = 0;
          
          // Process each chunk
          for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(file.size, start + chunkSize);
            const chunk = file.slice(start, end);
            
            // Upload this chunk
            const { data, error } = await supabaseClient
              .storage
              .from('pdfs')
              .upload(`${filename}_part${i}`, chunk, {
                cacheControl: '3600',
                upsert: true
              });
            
            if (error) {
              throw error;
            }
            
            // Update progress
            uploadedChunks++;
            const progress = Math.round((uploadedChunks / totalChunks) * 100);
            document.getElementById('pdfUploadProgress').textContent = `Uploading PDF: ${progress}%`;
          }
          
          // All chunks uploaded, now combine them (this happens client-side)
          document.getElementById('pdfUploadProgress').textContent = 'Finalizing upload...';
          
          // Get URLs for all chunks
          const chunkUrls = [];
          for (let i = 0; i < totalChunks; i++) {
            const { data } = supabaseClient
              .storage
              .from('pdfs')
              .getPublicUrl(`${filename}_part${i}`);
            
            chunkUrls.push(data.publicUrl);
          }
          
          // Store the chunk information in a metadata file
          const metadata = {
            originalFilename: file.name,
            totalChunks: totalChunks,
            chunkUrls: chunkUrls,
            mimeType: file.type,
            size: file.size,
            timestamp: timestamp
          };
          
          const metadataBlob = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
          
          const { data: metadataData, error: metadataError } = await supabaseClient
            .storage
            .from('pdfs')
            .upload(`${filename}_metadata.json`, metadataBlob, {
              cacheControl: '3600',
              upsert: true
            });
          
          if (metadataError) {
            throw metadataError;
          }
          
          // Get the metadata URL which will be used for downloading
          const { data: metadataUrlData } = supabaseClient
            .storage
            .from('pdfs')
            .getPublicUrl(`${filename}_metadata.json`);
          
          document.getElementById('pdfUploadProgress').textContent = 'PDF uploaded successfully!';
          
          // Hide status after a delay
          setTimeout(() => {
            document.getElementById('notesPdfUploadStatus').style.display = 'none';
          }, 3000);
          
          // Return the metadata URL as the PDF URL
          return metadataUrlData.publicUrl;
        }
      } catch (error) {
        console.error('PDF upload error:', error);
        document.getElementById('pdfUploadProgress').textContent = `Failed to upload PDF: ${error.message || 'Unknown error'}`;
        throw error;
      }
    }
    
    // Function to upload notes images
    async function uploadNotesImages() {
      const files = document.getElementById('notesImageUpload').files;
      const imageUrls = [];
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
          // Update progress status
          document.getElementById('notesUploadProgress').textContent = `Uploading image ${i+1} of ${files.length}...`;
          
          // Create FormData with the image file
          const formData = new FormData();
          formData.append('image', file);
          
          // Upload to ImgBB API
          const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`Failed to upload image ${i+1}`);
          }
          
          const data = await response.json();
          imageUrls.push(data.data.url);
          
          // Create and display image preview
          const previewContainer = document.getElementById('notesImagePreviews');
          const previewDiv = document.createElement('div');
          previewDiv.className = 'image-preview';
          
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          
          const removeButton = document.createElement('span');
          removeButton.className = 'remove-image';
          removeButton.innerHTML = '&times;';
          removeButton.onclick = function() {
            previewDiv.remove();
            // Remove from the upload queue logic would go here in a real implementation
          };
          
          previewDiv.appendChild(img);
          previewDiv.appendChild(removeButton);
          previewContainer.appendChild(previewDiv);
        } catch (error) {
          console.error(`Error uploading image ${i+1}:`, error);
          document.getElementById('notesUploadProgress').textContent = `Failed to upload image ${i+1}`;
          throw error;
        }
      }
      
      document.getElementById('notesUploadProgress').textContent = 'All images uploaded successfully!';
      return imageUrls;
    }
  }
</script>

</body>
</html>
