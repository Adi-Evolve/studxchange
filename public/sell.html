<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sell Your Products - StudXchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Leaflet.js for OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet Search Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f4f6f9;
      color: #333;
      min-height: 100vh;
    }
  
    main {
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    
    .sell-container {
      display: flex;
      width: 100%;
      max-width: 1200px;
      gap: 20px;
    }
    
    .sell-page {
      flex: 1;
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .sell-page h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2a3d56;
    }
    
    .sell-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .form-column {
      flex: 1;
      min-width: 250px;
    }
    
    .sell-form label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
      color: #2a3d56;
    }
    
    .sell-form input,
    .sell-form select,
    .sell-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .sell-form button {
      width: 100%;
      padding: 10px;
      background-color: #2a3d56;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .sell-form button:hover {
      background-color: #4d6a88;
    }
    
    /* Room specific styles */
    .room-form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .room-form-left, .room-form-right {
      flex: 1;
      min-width: 250px;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    
    .location-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .location-button {
   
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      background-color: #28a745;
      color: black;
    border: none;
    border-radius: 5px;
      padding: 10px;
    cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .location-button:hover {
      background-color: #218838;
    }
    
    .price-container {
        display: flex;
        gap: 10px;
      margin-bottom: 15px;
    }
    
    .price-container input {
      flex: 2;
    }
    
    .price-container select {
      flex: 1;
    }
    
    .image-preview-container {
      display: flex;
        flex-wrap: wrap;
      gap: 10px;
        margin-bottom: 15px;
    }

    .image-preview {
      width: 80px;
      height: 80px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
    }

    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-image {
        position: absolute;
        top: 2px;
        right: 2px;
        background: red;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }

    #imageUploadStatus {
        display: none;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    /* Keep existing modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto; /* Make modal scrollable */
    }
    
    .modal-content {
      background-color: #fff;
      margin: 5% auto; /* Reduced from 15% to 5% to show more content */
            padding: 20px;
      width: 80%;
            max-width: 400px;
      border-radius: 5px;
            text-align: center;
    }
    
    /* Map modal specific styles */
    #mapModal .modal-content {
      max-width: 800px;
      margin: 2% auto;
      height: auto; /* Changed from fixed height to auto */
      max-height: 90vh; /* Increased max height */
      overflow-y: auto; /* Make content scrollable */
    }
    
    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      margin-bottom: 15px;
      z-index: 1; /* Ensure proper z-index */
    }
    
    /* Add loading indicator for map */
    .map-loading {
      display: none;
      text-align: center;
      padding: 20px;
      font-weight: bold;
      color: #666;
    }

    .map-loading i {
      margin-right: 10px;
      color: #2a3d56;
    }
    
    .modal button {
            background-color: #2a3d56;
            color: white;
      padding: 10px 20px;
            border: none;
      border-radius: 5px;
            cursor: pointer;
      margin-top: 15px;
    }
    
    /* Keep existing navbar styles */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2a3d56;
      padding: 15px 30px;
      /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
    }
    .navlogo img {
      height: 100px;
      width: 250px;
    }
    .navbar .button-container {
      display: flex;
      gap: 20px;
    }

    /* Search Bar Desktop */
    .search-container {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .searchbar {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 30px;
      padding: 2px;
      width: 100%;
      max-width: 600px;
    }
    .searchbar select,
    .searchbar input,
    .searchbar button {
      border: none;
      padding: 10px;
    }
    .searchbar select {
      background: #2a3d56;
      color: white;
      border-radius: 30px 0 0 30px;
    }
    .searchbar input {
      width: 100%;
    }
    .searchbar button {
      background: #2a3d56;
      color: white;
      border-radius: 0 30px 30px 0;
    }
    /* ===== Profile/Signup Button ===== */
    .button-container {
            display: flex;
      gap: 20px;
            align-items: center;
    }
    .profile-button, .signup-button {
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      transition: background 0.3s;
    }
    .profile-button {
      background: transparent;
    }
    .signup-button {
      background: #1a75ff;
      cursor: pointer;
    }
    .navbar a:hover {
      background-color: #4d6a88;
    }
    .navbar .button-container {
      display: flex;
      gap: 20px;
    }
    /* ===== Updated Button Styles ===== */
    .nav-button {
      padding: 10px 25px;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-weight: 500;
      display: inline-block;
    }
    /* Sell Button */
    .sell-button {
    color: white;
      background-color: transparent;
      border-color: transparent;
    }
    .sell-button:hover {
      background-color: #546e78;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Signup Button */
    .signup-button {
      color: white;
      background-color: transparent;
      border-color: transparent;
    }
    .signup-button:hover {
      background-color: #546e78;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Profile Button */
    .profile-button {
      color: white;
      background-color: #2a3d56;
      border-color: transparent;
    }
    .profile-button:hover {
      background-color: #1a2a3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* Common Hover Effects */
    .nav-button:hover {
      border-color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
    }
    /* ===== Mobile Responsive Styles ===== */
    @media (max-width: 768px) {
      /* Navbar Mobile */
      .navbar {
        flex-direction: column;
        padding: 15px;
      }
      
      .navlogo img {
        height: 80px;
        width: 200px;
        margin-bottom: 15px;
      }
      
      .search-container {
        width: 100%;
    margin: 15px 0;
}

      .button-container {
        flex-direction: column;
        width: 100%;
        gap: 10px;
        margin-top: 15px;
      }
      
      /* Search Bar Mobile */
      .searchbar select {
        padding: 8px;
        font-size: 14px;
      }
      
      .searchbar input {
        font-size: 14px;
      }
      
      .searchbar button {
        padding: 2px;
      }
}
  </style>
  <script src="js/db-config.js"></script>
</head>
<body>
  <!-- Common Navbar -->
  <header id="common-navbar"></header>
  
  <main>
    <div class="sell-container">
    <section class="sell-page">
      <h1>Sell Your Products</h1>
      <form class="sell-form" id="sellForm">
          <div class="form-column">
        <label for="category">Category</label>
        <select id="category" name="category" required>
          <option value="Laptop">Laptop</option>
          <option value="Books">Books</option>
          <option value="Notes">Notes</option>
          <option value="project equipments">Project Equipments</option>
          <option value="electronics">Electronics</option>
          <option value="Room">Room</option>
          <option value="Hostel Equipments">Hostel Equipments</option>
          <option value="stationery">Stationery</option>
          <option value="Vehicle">Cycle/Bike</option>
          <option value="others">Others</option>
        </select>
            
            <label for="college">Select College</label>
            <select id="college" name="college" required>
              <option value="all">All</option>
              <option value="VIT">Vishwakarma Institute of Technology</option>
              <option value="COEP">College Of Engineering</option>
              <option value="PICT">PICT, Balaji Nagar</option>
              <option value="DYP">D.Y.Patil Engineering College</option>
              <option value="PCCOE">Pimpri Chinchwad College of Engineering</option>
            </select>
            
            <!-- Regular product form fields -->
            <div id="regularForm">
              <label for="title">Product Title</label>
              <input type="text" id="title" name="title" placeholder="e.g., Books, Scientific Calculator, Laptop" required>
              
        <label for="price">Set Price (₹)</label>
        <input type="number" id="price" name="price" placeholder="Enter price" required>
        
              <label for="condition">Condition</label>
              <select id="condition" name="condition" required>
                <option value="new">New</option>
                <option value="used">Used</option>
                <option value="refurbished">Refurbished</option>
              </select>
            </div>
          </div>
          
          <div class="form-column">
            <!-- Regular product form fields continued -->
            <div id="regularFormCont">
              <label for="imageUpload">Upload Product Images (1-5)</label>
        <div class="image-preview-container" id="imagePreviews"></div>
        <input type="file" id="imageUpload" accept="image/*" multiple required>
<div id="imageUploadStatus" aria-live="polite">
  <i class="fas fa-spinner fa-spin"></i>
  <span id="uploadProgress">Uploading images...</span>
</div>
              
        <label for="description">Description</label>
        <textarea id="description" name="description" rows="5" placeholder="Write a detailed description of your product" required></textarea>
              
              <div id="locationSection">
                <button type="button" id="getLocationBtn" class="location-button">
                  <i class="fas fa-map-marker-alt"></i> Use Current Location
                </button>
                <small id="locationStatus">Location not yet obtained</small>
              </div>
            </div>
            
            <!-- Room specific form fields -->
            <div id="roomForm" class="room-form">
              <div class="room-form-left">
                <label for="hostelName">Hostel/PG Name</label>
                <input type="text" id="hostelName" name="hostelName" placeholder="Enter hostel or PG name">
                
                <label for="roomImageUpload">Upload Room Images (up to 10)</label>
                <div class="image-preview-container" id="roomImagePreviews"></div>
                <input type="file" id="roomImageUpload" accept="image/*" multiple>
                <small>Maximum 50MB total</small>
                <div id="roomImageUploadStatus" aria-live="polite" style="display: none;">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span id="roomUploadProgress">Uploading images...</span>
                </div>
                
                <label for="ownerName">Owner Name</label>
                <input type="text" id="ownerName" name="ownerName" placeholder="Enter owner name">
                
                <label for="contact1">Contact Number 1</label>
                <input type="tel" id="contact1" name="contact1" placeholder="Enter primary contact number" pattern="[0-9]{10}">
                
                <label for="contact2">Contact Number 2 (Optional)</label>
                <input type="tel" id="contact2" name="contact2" placeholder="Enter secondary contact number" pattern="[0-9]{10}">
                
                <div class="location-buttons">
                  <button type="button" id="currentLocationBtn" class="location-button">
                    <i class="fas fa-map-marker-alt"></i> Current Location
                  </button>
                  <button type="button" id="mapLocationBtn" class="location-button">
                    <i class="fas fa-map"></i> Select on Map
                  </button>
                </div>
                <small id="roomLocationStatus">Location not yet obtained</small>
              </div>
              
              <div class="room-form-right">
                <label for="collegeDistance">Distance from College (km)</label>
                <input type="number" id="collegeDistance" name="collegeDistance" placeholder="Enter distance in kilometers" step="0.1">
                
                <label for="occupancy">Occupancy</label>
                <input type="number" id="occupancy" name="occupancy" placeholder="Number of people" min="1">
                
                <label>Amenities</label>
                <div class="checkbox-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="ac" name="amenities" value="ac">
                    <label for="ac">AC</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="wifi" name="amenities" value="wifi">
                    <label for="wifi">WiFi</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="washingMachine" name="amenities" value="washingMachine">
                    <label for="washingMachine">Washing Machine</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="mess" name="amenities" value="mess">
                    <label for="mess">Mess Included</label>
                  </div>
                </div>
                
                <div id="messSection" style="display: none;">
                  <label for="messPrice">Mess Price (₹)</label>
                  <input type="number" id="messPrice" name="messPrice" placeholder="Enter mess price">
                </div>
                
                <div class="checkbox-item">
                  <input type="checkbox" id="installment" name="installment">
                  <label for="installment">Installment Option Available</label>
                </div>
                
                <label for="roomPrice">Price</label>
                <div class="price-container">
                  <input type="number" id="roomPrice" name="roomPrice" placeholder="Enter price" required>
                  <select id="priceType" name="priceType">
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
        </select>
                </div>
              </div>
            </div>
            
            <button type="submit" id="submitButton">Submit</button>
          </div>
        </form>
      </section>
    </div>
  </main>
  
        <div id="phoneErrorModal" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closePhoneErrorModal()">&times;</span>
              <h2>Phone Number Required</h2>
              <p>You need to add a phone number to list items for sale.</p>
              <button onclick="redirectToProfile()">Add Phone Number</button>
          </div>
      </div>
  
  <!-- Google Maps Modal -->
  <div id="mapModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMapModal()">&times;</span>
      <h2>Select Location</h2>
      <div style="display: flex; margin-bottom: 10px;">
        <input type="text" id="mapSearchInput" placeholder="Search for a location" style="flex: 1; padding: 8px; margin-right: 10px;">
        <button onclick="searchLocation()" style="padding: 8px 15px; background: #2a3d56; color: white; border: none; border-radius: 4px;">Search</button>
      </div>
      <div id="mapLoading" class="map-loading">
        <i class="fas fa-spinner fa-spin"></i> Loading map...
      </div>
      <div id="map"></div>
      <div style="margin-top: 15px; display: flex; justify-content: space-between; flex-wrap: wrap;">
        <div id="selectedLocationDisplay" style="flex: 1; padding: 8px; background: #f4f4f4; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; min-width: 200px;">No location selected</div>
        <button onclick="confirmMapLocation()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px;">Confirm Location</button>
      </div>
    </div>
  </div>
  
  <script src="js/navbar.js"></script>
  <script>
    // Configuration
    const IMGBB_API_KEY = '272785e1c6e6221d927bad99483ff9ed';
    const IMGBB_UPLOAD_URL = 'https://api.imgbb.com/1/upload';
    let userCoordinates = null;
let userLocationName = '';

    // Toggle between regular and room forms based on category selection
    document.getElementById('category').addEventListener('change', function() {
      const isRoom = this.value === 'Room';
      
    // Toggle display of form sections
  document.getElementById('regularForm').style.display = isRoom ? 'none' : 'block';
  document.getElementById('regularFormCont').style.display = isRoom ? 'none' : 'block';
  document.getElementById('roomForm').style.display = isRoom ? 'block' : 'none';
  
      // Toggle required attributes for regular product fields
      const regularFields = ['title', 'price', 'condition', 'description'];
  regularFields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      if (isRoom) {
        element.removeAttribute('required');
      } else {
        element.setAttribute('required', 'required');
      }
    }
  });
      
      // Toggle required attributes for room fields
      const roomFields = ['roomPrice'];
  roomFields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      if (isRoom) {
        element.setAttribute('required', '');
      } else {
        element.removeAttribute('required');
      }
        }
      });
      
      // Toggle required attribute for image upload
      const regularImageUpload = document.getElementById('imageUpload');
  const roomImageUpload = document.getElementById('roomImageUpload');
  
  if (isRoom) {
    regularImageUpload.removeAttribute('required');
    roomImageUpload.setAttribute('required', 'required');
  } else {
    regularImageUpload.setAttribute('required', 'required');
    roomImageUpload.removeAttribute('required');
  }
    });
    
    // Toggle mess price input based on mess checkbox
    document.getElementById('mess').addEventListener('change', function() {
      document.getElementById('messSection').style.display = this.checked ? 'block' : 'none';
    });
    
    // Location handling for regular products
async function getAddressFromCoords(lat, lon) {
    try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&email=your@email.com`
        );
        const data = await response.json();
        return data.display_name || 'Location obtained';
    } catch (error) {
        console.error('Reverse geocoding error:', error);
        return 'Approximate location';
    }
}

document.getElementById('getLocationBtn').addEventListener('click', async () => {
    try {
        document.getElementById('locationStatus').textContent = 'Getting location...';
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        userCoordinates = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
        };
        
        userLocationName = await getAddressFromCoords(userCoordinates.lat, userCoordinates.lon);
        
        // Update the location status with an icon and location name
        const locationStatus = document.getElementById('locationStatus');
        locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${userLocationName}`;
        locationStatus.style.color = '#28a745';
    } catch (error) {
        console.error('Location error:', error);
        document.getElementById('locationStatus').textContent = 'Failed to get location';
        document.getElementById('locationStatus').style.color = '#dc3545';
      }
    });
    
    // Current location for room
    document.getElementById('currentLocationBtn').addEventListener('click', async () => {
      try {
        document.getElementById('roomLocationStatus').textContent = 'Getting location...';
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        userCoordinates = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };
        
        userLocationName = await getAddressFromCoords(userCoordinates.lat, userCoordinates.lon);
        
        // Update the location status with an icon and location name
        const locationStatus = document.getElementById('roomLocationStatus');
        locationStatus.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${userLocationName}`;
        locationStatus.style.color = '#28a745';
        } catch (error) {
        console.error('Location error:', error);
        document.getElementById('roomLocationStatus').textContent = 'Failed to get location';
        document.getElementById('roomLocationStatus').style.color = '#dc3545';
      }
    });
    
    // Google Maps location for room (placeholder - would need Google Maps API integration)
    document.getElementById('mapLocationBtn').addEventListener('click', openMapModal);
    
    // Image upload handling for regular products
    async function uploadImages(isRoom = false) {
      const fileInput = isRoom ? document.getElementById('roomImageUpload') : document.getElementById('imageUpload');
    const files = Array.from(fileInput.files);
    
    if (files.length === 0) throw new Error('No images selected');
      if (!isRoom && files.length > 5) throw new Error('Maximum 5 images allowed');
      if (isRoom && files.length > 10) throw new Error('Maximum 10 images allowed');

      const statusElement = isRoom ? document.getElementById('roomImageUploadStatus') : document.getElementById('imageUploadStatus');
      const progressElement = isRoom ? document.getElementById('roomUploadProgress') : document.getElementById('uploadProgress');
    const uploadedUrls = [];

      // Check file size limit for room images (50MB total)
      if (isRoom) {
        const totalSize = files.reduce((sum, file) => sum + file.size, 0);
        const MAX_SIZE = 50 * 1024 * 1024; // 50MB
        if (totalSize > MAX_SIZE) {
          throw new Error('Total file size exceeds 50MB limit');
        }
      }

    try {
        statusElement.style.display = 'flex';
        
        for (let i = 0; i < files.length; i++) {
            progressElement.textContent = `Uploading images (${i+1}/${files.length})...`;
            
            const formData = new FormData();
            formData.append('image', files[i]);

            const response = await fetch(`${IMGBB_UPLOAD_URL}?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (!data.success) throw new Error(data.error.message || 'Image upload failed');
            uploadedUrls.push(data.data.url);
        }

        return uploadedUrls;
    } catch (error) {
        console.error("Image upload error:", error);
        throw new Error('Image upload failed: ' + error.message);
    } finally {
        statusElement.style.display = 'none';
    }
    }
    
    // Regular product image preview
document.getElementById('imageUpload').addEventListener('change', function(e) {
    const previewContainer = document.getElementById('imagePreviews');
    previewContainer.innerHTML = '';
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    const invalidFiles = Array.from(this.files).filter(file => 
        !allowedTypes.includes(file.type)
    );
      
    if (invalidFiles.length > 0) {
        alert('Only JPG, PNG, and WEBP images are allowed');
        this.value = '';
        return;
    }
      
    if (this.files.length > 5) {
        alert('Maximum 5 images allowed');
        this.value = '';
        return;
    }

    Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}">
            <div class="remove-image" onclick="removeImage(${index}, false)">×</div>
            `;
            previewContainer.appendChild(preview);
        }
        reader.readAsDataURL(file);
    });
});
    
    // Room image preview
    document.getElementById('roomImageUpload').addEventListener('change', function(e) {
      const previewContainer = document.getElementById('roomImagePreviews');
      previewContainer.innerHTML = '';
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const invalidFiles = Array.from(this.files).filter(file => 
        !allowedTypes.includes(file.type)
      );
      
      if (invalidFiles.length > 0) {
        alert('Only JPG, PNG, and WEBP images are allowed');
        this.value = '';
        return;
      }
      
      if (this.files.length > 10) {
        alert('Maximum 10 images allowed');
        this.value = '';
        return;
      }
      
      // Check total size
      const totalSize = Array.from(this.files).reduce((sum, file) => sum + file.size, 0);
      const MAX_SIZE = 50 * 1024 * 1024; // 50MB
      if (totalSize > MAX_SIZE) {
        alert('Total file size exceeds 50MB limit');
        this.value = '';
        return;
      }

      Array.from(this.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview ${index + 1}">
            <div class="remove-image" onclick="removeImage(${index}, true)">×</div>
          `;
          previewContainer.appendChild(preview);
        }
        reader.readAsDataURL(file);
      });
    });
    
    // Remove image function
    function removeImage(index, isRoom) {
      const fileInputId = isRoom ? 'roomImageUpload' : 'imageUpload';
      const files = Array.from(document.getElementById(fileInputId).files);
    files.splice(index, 1);
    
    // Create new DataTransfer object and update files
    const newFiles = new DataTransfer();
    files.forEach(file => newFiles.items.add(file));
      document.getElementById(fileInputId).files = newFiles.files;
    
    // Trigger change event to update previews
      document.getElementById(fileInputId).dispatchEvent(new Event('change'));
}

    // Form submission
    document.getElementById('sellForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      console.log("Form submission started");

      // Check if user has coordinates
        if (!userCoordinates) {
        alert("Please provide your location to continue.");
        console.log("Location not provided");
        return;
    }
      
      // Check if user has phone number
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser || !currentUser.phone) {
        // Show error modal
        document.getElementById('phoneErrorModal').style.display = 'block';
        console.log("Phone number not provided");
        return;
      }
      
      try {
        const category = document.getElementById('category').value;
        console.log("Form type:", category);
        
        // Get common fields
        const college = document.getElementById('college').value;
        
        // Check if it's a room listing
        if (category === 'Room') {
          // Validate room fields
          const hostelName = document.getElementById('hostelName').value;
          if (!hostelName) {
            alert("Please enter a hostel/PG name");
            return;
          }
          
          const roomPrice = document.getElementById('roomPrice').value;
          if (!roomPrice) {
            alert("Please enter a price");
            return;
          }
          
          // Check if at least one image is uploaded
          const roomImages = document.getElementById('roomImageUpload').files;
          if (roomImages.length === 0) {
            alert("Please upload at least one image");
            return;
          }
          
          // Check if more than 10 images are uploaded
          if (roomImages.length > 10) {
            alert("You can upload a maximum of 10 images");
            return;
          }
          
          // Show upload status
          document.getElementById('roomImageUploadStatus').style.display = 'flex';
          
          // Upload images to ImgBB
          const uploadedRoomImages = await Promise.all(
            Array.from(roomImages).map(file => uploadImage(file))
          );
          
          // Create room object
          const room = {
            college,
            title: hostelName, // Use hostelName as the title
            category,
            hostelName,
            ownerName: document.getElementById('ownerName').value,
            contact1: document.getElementById('contact1').value,
            contact2: document.getElementById('contact2').value || null,
            images: uploadedRoomImages,
            coordinates: userCoordinates,
            location: userLocationName,
            collegeDistance: parseFloat(document.getElementById('collegeDistance').value) || null,
            occupancy: parseInt(document.getElementById('occupancy').value) || null,
            amenities: Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value),
            hasAC: document.getElementById('ac').checked,
            hasWifi: document.getElementById('wifi').checked,
            hasWashingMachine: document.getElementById('washingMachine').checked,
            hasMess: document.getElementById('mess').checked,
            messPrice: document.getElementById('mess').checked ? parseFloat(document.getElementById('messPrice').value) || null : null,
            hasInstallment: document.getElementById('installment').checked,
            price: roomPrice,
            priceType: document.getElementById('priceType').value,
            sellerPhone: currentUser.phone,
            sellerEmail: currentUser.email
          };
          
          // Save room to MongoDB
          const response = await fetch(API_ENDPOINTS.ADD_ROOM, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(room)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save room listing');
          }
          
          alert('Room listed successfully!');
          window.location.href = 'index.html';
        } else {
          // Regular product submission (existing code)
        const files = document.getElementById('imageUpload').files;
    if (files.length < 1) {
        alert('Please select at least 1 image');
        return;
    }
          
    if (files.length > 5) {
        alert('Maximum 5 images allowed');
        return;
    }
          
          // Validate required fields
          const title = document.getElementById('title').value;
          const price = document.getElementById('price').value;
          const description = document.getElementById('description').value;
          
          if (!title || !price || !description) {
            alert('Please fill in all required fields');
            return;
        }

          // Show upload status
          document.getElementById('imageUploadStatus').style.display = 'flex';
            
          // Upload images
          const imageUrls = await uploadImages(false);
            
            // Create product object
            const product = {
            college: document.getElementById('college').value,
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                price: document.getElementById('price').value,
                images: imageUrls,
                description: document.getElementById('description').value,
                condition: document.getElementById('condition').value,
                sellerPhone: currentUser.phone,
                sellerEmail: currentUser.email,
            createdAt: new Date().toISOString(),
                location: userLocationName,
            coordinates: userCoordinates
            };

          console.log('Submitting product:', product);

          // Save product to MongoDB via the API
          const response = await fetch(API_ENDPOINTS.ADD_PRODUCT, {
            method: 'POST',
                headers: {
              'Content-Type': 'application/json'
                },
            body: JSON.stringify(product)
            });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save product');
          }
            
            alert('Product listed successfully!');
            window.location.href = 'index.html';
        }
        } catch (error) {
            console.error("Form submission error:", error);
        alert(error.message || 'Failed to submit listing');
        } finally {
        document.getElementById('imageUploadStatus').style.display = 'none';
        document.getElementById('roomImageUploadStatus').style.display = 'none';
        }
    });


    

    // Modal functions
    function redirectToProfile() {
      window.location.href = 'PROFILE_FINAL.html';
    }

    function closePhoneErrorModal() {
        document.getElementById('phoneErrorModal').style.display = 'none';
    }

    // Initialize form state
    document.addEventListener('DOMContentLoaded', () => {
      // Hide room form by default
      document.getElementById('roomForm').style.display = 'none';
      
      // Set initial required attributes
      document.getElementById('roomPrice').removeAttribute('required');
      document.getElementById('roomImageUpload').removeAttribute('required');
      
      // Check for draft data
        const draftData = JSON.parse(localStorage.getItem('draftListing'));
        if (draftData) {
        // Populate form fields from draft
        document.getElementById('college').value = draftData.college || '';
            document.getElementById('category').value = draftData.category || '';
        
        // Trigger change event to show/hide appropriate form
        const event = new Event('change');
        document.getElementById('category').dispatchEvent(event);
        
        if (draftData.category === 'Room') {
          // Populate room form fields
          document.getElementById('hostelName').value = draftData.hostelName || '';
          document.getElementById('ownerName').value = draftData.ownerName || '';
          document.getElementById('contact1').value = draftData.contact1 || '';
          document.getElementById('contact2').value = draftData.contact2 || '';
          document.getElementById('collegeDistance').value = draftData.collegeDistance || '';
          document.getElementById('occupancy').value = draftData.occupancy || '';
          document.getElementById('roomPrice').value = draftData.price || '';
          document.getElementById('priceType').value = draftData.priceType || 'monthly';
          
          // Set amenities checkboxes
          if (draftData.hasAC) document.getElementById('ac').checked = true;
          if (draftData.hasWifi) document.getElementById('wifi').checked = true;
          if (draftData.hasWashingMachine) document.getElementById('washingMachine').checked = true;
          if (draftData.hasMess) {
            document.getElementById('mess').checked = true;
            document.getElementById('messSection').style.display = 'block';
            document.getElementById('messPrice').value = draftData.messPrice || '';
          }
          if (draftData.hasInstallment) document.getElementById('installment').checked = true;
        } else {
          // Populate regular form fields
          document.getElementById('title').value = draftData.title || '';
            document.getElementById('price').value = draftData.price || '';
          document.getElementById('condition').value = draftData.condition || 'used';
            document.getElementById('description').value = draftData.description || '';
        }
        
        // Set coordinates if available
        if (draftData.coordinates) {
          userCoordinates = draftData.coordinates;
          userLocationName = draftData.location || '';
          
          const locationStatus = document.getElementById(draftData.category === 'Room' ? 'roomLocationStatus' : 'locationStatus');
          locationStatus.textContent = userLocationName;
          locationStatus.style.color = '#28a745';
        }
      }
    });
    
    // Make the map modal and initialization more robust
    function openMapModal() {
      // Show modal
      const mapModal = document.getElementById('mapModal');
      mapModal.style.display = 'block';
      
      // Show loading indicator
      const mapLoading = document.getElementById('mapLoading');
      mapLoading.style.display = 'block';
      
      // Reset attempts counter
      mapInitAttempts = 0;
      
      // Ensure the scripts are loaded
      const leafletLoaded = typeof L !== 'undefined';
      const geocoderLoaded = leafletLoaded && typeof L.Control.Geocoder !== 'undefined';
      
      if (!leafletLoaded) {
        console.error("Leaflet library not loaded");
        mapLoading.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Map library not loaded. Please refresh the page.';
        return;
      }
      
      if (!geocoderLoaded) {
        console.warn("Geocoder plugin not loaded - search functionality may be limited");
      }
      
      // Wait for the modal to be visible before initializing the map
      setTimeout(() => {
        try {
          // Focus the search input after map loads
          setTimeout(() => {
            const searchInput = document.getElementById('mapSearchInput');
            if (searchInput) searchInput.focus();
          }, 800);
          
          initMap();
        } catch (error) {
          console.error("Error initializing map:", error);
          mapLoading.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading map: ' + error.message;
        }
      }, 600); // Increased timeout to ensure modal is fully rendered
    }
    
    // Initialize the map
    let mapInitAttempts = 0;
    function initMap() {
      const mapContainer = document.getElementById('map');
      
      // Check if map container is properly rendered
      if (!mapContainer || mapContainer.offsetWidth === 0 || mapContainer.offsetHeight === 0) {
        console.log(`Map container not properly rendered, waiting... (attempt ${mapInitAttempts+1}/6)`);
        
        // Limit the number of attempts
        if (mapInitAttempts >= 5) {
          console.error("Map container still not properly rendered after multiple attempts");
          document.getElementById('mapLoading').innerHTML = 
            '<i class="fas fa-exclamation-triangle"></i> Map container not available. Please try closing and reopening.';
          return;
        }
        
        mapInitAttempts++;
        setTimeout(initMap, 300); // Try again after a short delay
        return;
      }
      
      // Safe cleanup of any existing map instance
      if (window.map) {
        try {
          window.map.off();
          window.map.remove();
        } catch (e) {
          console.log("Error cleaning up previous map:", e);
        }
        window.map = null;
      }
      
      try {
        console.log("Creating new map instance");
        
        // Create map with specific options to prevent common issues
        window.map = L.map('map', {
          zoomControl: true,
          attributionControl: true,
          fadeAnimation: false, // Disable animations to reduce rendering issues
          markerZoomAnimation: false
        });
        
        // Set view after map is initialized
        window.map.setView([18.5204, 73.8567], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap contributors'
        }).addTo(window.map);
        
        // Force an immediate invalidateSize
        setTimeout(() => {
          if (window.map) {
            try {
              window.map.invalidateSize(true);
              console.log("Map size invalidated");
            } catch (e) {
              console.error("Error invalidating map size:", e);
            }
          }
        }, 100);
        
        console.log("Map and tiles initialized");
        
        // Add geocoder control for searching locations if available
        if (typeof L.Control.Geocoder !== 'undefined') {
          try {
            const geocoder = L.Control.Geocoder.nominatim({
              geocodingQueryParams: { 
                format: 'json',
                addressdetails: 1,
                limit: 5
              }
            });
            
            L.Control.geocoder({
              defaultMarkGeocode: false,
              placeholder: 'Search for places...',
              geocoder: geocoder
            }).on('markgeocode', function(e) {
              const result = e.geocode;
              
              // Clear any existing markers
              if (window.marker) {
                window.map.removeLayer(window.marker);
              }
              
              // Add marker at the selected location
              window.marker = L.marker(result.center).addTo(window.map);
              
              // Set the selected location
              userCoordinates = {
                lat: result.center.lat,
                lon: result.center.lng
              };
              userLocationName = result.name || result.html || 'Selected location';
              
              // Update the selected location display
              document.getElementById('selectedLocationDisplay').textContent = userLocationName;
              
              // Zoom to the selected location
              window.map.fitBounds(result.bbox || [[result.center.lat - 0.01, result.center.lng - 0.01], 
                                                 [result.center.lat + 0.01, result.center.lng + 0.01]]);
            }).addTo(window.map);
            
            console.log("Geocoder initialized");
          } catch (geocoderError) {
            console.error("Geocoder error:", geocoderError);
            // Continue without geocoder if it fails
          }
        } else {
          console.warn("Geocoder control not available");
        }
        
        // Handle map clicks to set location
        window.map.on('click', function(e) {
          // Clear any existing markers
          if (window.marker) {
            window.map.removeLayer(window.marker);
          }
          
          // Add marker at the clicked location
          window.marker = L.marker(e.latlng).addTo(window.map);
          
          // Set the selected location
          userCoordinates = {
            lat: e.latlng.lat,
            lon: e.latlng.lng
          };
          
          // Set temporary display while geocoding
          document.getElementById('selectedLocationDisplay').textContent = `Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;
          
          // Reverse geocode to get the location name
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&accept-language=en`)
            .then(response => response.json())
            .then(data => {
              userLocationName = data.display_name || 'Selected location';
              document.getElementById('selectedLocationDisplay').textContent = userLocationName;
            })
            .catch(error => {
              console.error('Error reverse geocoding:', error);
              // Keep the coordinates as display if geocoding fails
            });
        });
        
        // If user already has coordinates, show them on the map
        if (userCoordinates) {
          const latlng = L.latLng(userCoordinates.lat, userCoordinates.lon);
          window.marker = L.marker(latlng).addTo(window.map);
          window.map.setView(latlng, 15);
          document.getElementById('selectedLocationDisplay').textContent = userLocationName || 'Location selected';
        }
        
        // Hide loading indicator once map is initialized
        document.getElementById('mapLoading').style.display = 'none';
        
      } catch (mapError) {
        console.error("Error in map initialization:", mapError);
        document.getElementById('mapLoading').innerHTML = 
          '<i class="fas fa-exclamation-triangle"></i> Error initializing map: ' + mapError.message;
      }
    }
    
    // Search for a location using the search input
    function searchLocation() {
      const searchInput = document.getElementById('mapSearchInput').value;
      if (!searchInput) {
        alert('Please enter a location to search');
        return;
      }
      
      // Show temporary search message
      document.getElementById('selectedLocationDisplay').textContent = `Searching for "${searchInput}"...`;
      
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchInput)}&accept-language=en`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const result = data[0];
            
            // Clear any existing markers
            if (window.marker) {
              window.map.removeLayer(window.marker);
            }
            
            // Add marker at the selected location
            const latlng = L.latLng(result.lat, result.lon);
            window.marker = L.marker(latlng).addTo(window.map);
            
            // Set the selected location
            userCoordinates = {
              lat: parseFloat(result.lat),
              lon: parseFloat(result.lon)
            };
            userLocationName = result.display_name;
            
            // Update the selected location display
            document.getElementById('selectedLocationDisplay').textContent = userLocationName;
            
            // Zoom to the selected location
            window.map.setView(latlng, 15);
          } else {
            alert('Location not found. Please try a different search term.');
            document.getElementById('selectedLocationDisplay').textContent = 'No location selected';
          }
        })
        .catch(error => {
          console.error('Error searching for location:', error);
          alert('Error searching for location. Please try again.');
          document.getElementById('selectedLocationDisplay').textContent = 'Search failed';
        });
    }
    
    // Close the map modal
    function closeMapModal() {
      document.getElementById('mapModal').style.display = 'none';
    }
    
    // Confirm the selected location
    function confirmMapLocation() {
      if (!userCoordinates) {
        alert('Please select a location on the map first.');
        return;
      }
      
      // Update the location status
      const locationStatus = document.getElementById(document.getElementById('category').value === 'Room' ? 'roomLocationStatus' : 'locationStatus');
      locationStatus.textContent = userLocationName || 'Location selected';
      locationStatus.style.color = '#28a745';
      
      // Close the modal
      closeMapModal();
    }
    
    // Add event listener for the Enter key in the search input
    document.getElementById('mapSearchInput').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        searchLocation();
        }
    });
</script>
</body>
</html>
