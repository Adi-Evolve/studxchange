<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Interface - StudXchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" />
  <script src="js/db-config.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <script src="js/firebase-config.js"></script>
  <style>
    :root {
      --primary-color: #2a3d56;
      --secondary-color: #2a3d56;
      --accent-color: #1a75ff;
      --text-color: #333;
      --bg-color: #f4f6f9;
      --white-color: #fff;
      --shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--primary-color);
      color: var(--white-color);
      padding: 1rem;
      text-align: center;
      box-shadow: var(--shadow);
    }

    main {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .product-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      background: var(--white-color);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 2rem;
    }

    .product-images {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .main-image-container {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      background-color: #eaeaea;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .main-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnails {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .thumbnail {
      flex: 0 0 auto;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .thumbnail:hover {
      transform: scale(1.05);
      opacity: 0.8;
    }

    .product-details {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .product-header {
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    .product-title {
      font-size: 2rem;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
    }

    .price-section {
      display: flex;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .current-price {
      font-size: 1.75rem;
      color: var(--accent-color);
      font-weight: bold;
    }

    .original-price {
      color: #777;
      text-decoration: line-through;
      font-size: 1rem;
    }

    .product-condition {
      font-size: 1rem;
      color: #666;
      margin-top: 0.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: #28a745;
      color: var(--white-color);
      transition: all 0.3s ease;
    }

    .btn-secondary {
      background-color: #dc3545;
      color: var(--white-color);
      transition: all 0.3s ease;
    }

    .btn-compare {
      background-color: #007bff;
      color: var(--white-color);
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .product-description {
      margin: 2rem 0;
      line-height: 1.6;
    }

    .product-description p {
      line-height: 1.6;
      font-size: 1rem;
    }

    footer {
      background-color: var(--primary-color);
      color: var(--white-color);
      text-align: center;
      padding: 1.5rem;
      margin-top: auto;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--white-color);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: var(--shadow);
      border: 2px solid var(--accent-color);
    }

    .modal-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent-color);
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
    }

    .buyer-info {
      display: grid;
      gap: 1rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      .product-container {
        grid-template-columns: 1fr;
      }
      .main-image-container {
        height: 300px;
      }
      
      .room-layout {
        display: flex;
        flex-direction: column;
      }
      
      .room-images {
        order: 1;
      }
      
      .room-info {
        order: 2;
      }
      
      .room-description {
        order: 3;
      }
    }

    /* Seller Info Styles */
    #sellerInfoContent ul {
      list-style: none;
      padding: 0;
    }

    #sellerInfoContent li {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .compare-btn {
    background-color: var(--accent-color);
    color: var(--white-color);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 1rem;
    font-weight: bold;
    box-shadow: var(--shadow);
  }
  .compare-btn:hover {
    background-color: var(--primary-color);
    transform: scale(1.1);
  }

  .compare-modal-content {
    background: var(--white-color);
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 650px;
    position: relative;
    box-shadow: var(--shadow);
    border: 2px solid var(--accent-color);
  }
  
  .compare-search-bar {
    width: 100%;
    padding: 0.85rem;
    border: 2px solid var(--accent-color);
    border-radius: 10px;
    font-size: 1rem;
    margin-bottom: 1.5rem;
    outline: none;
    transition: all 0.3s ease-in-out;
    background: var(--bg-color);
    box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1);
    font-weight: bold;
    color: var(--text-color);
    padding-left: 2.5rem;
    background-image: url('https://cdn-icons-png.flaticon.com/512/622/622669.png');
    background-size: 20px;
    background-repeat: no-repeat;
    background-position: 10px center;
  }
  
  .compare-search-bar:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 8px rgba(26, 117, 255, 0.5);
    background-color: var(--white-color);
  }
  
  .product-list {
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid var(--accent-color);
    border-radius: 8px;
    padding: 1rem;
    background-color: var(--bg-color);
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
  }
  
  .product-list button {
    display: block;
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background-color: var(--white-color);
    border: 2px solid var(--accent-color);
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    transition: all 0.3s ease;
    font-weight: bold;
  }
  
  .product-list button:hover {
    background-color: var(--accent-color);
    color: var(--white-color);
    transform: scale(1.02);
  }
  
  .selected-products {
    margin-bottom: 1.5rem;
  }

  .selected-product {
    padding: 1rem;
    background-color: var(--bg-color);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    font-weight: bold;
    text-align: center;
    box-shadow: var(--shadow);
    color: var(--primary-color);
  }
  
  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.5rem;
    background: var(--white-color);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .comparison-table th,
  .comparison-table td {
    padding: 1rem;
    border: 1px solid #ddd;
    text-align: left;
  }

  .comparison-table th {
    background-color: var(--primary-color);
    color: var(--white-color);
  }

  .comparison-table tr:nth-child(even) {
    background-color: var(--bg-color);
  }

  .navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #2a3d56;
    padding: 15px 30px;
    /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
  }
  .navlogo img {
    height: 100px;
    width: 200px;
  }
  .search-container {
    flex: 1;
    display: flex;
    justify-content: center;
    margin: 0 20px;
  }
  .searchbar {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 30px;
    padding: 2px;
    width: 100%;
    max-width: 600px;
  }
  .category-select {
    background: #2a3d56;
    color: white;
    border-radius: 30px 0 0 30px;
    padding: 6px 10px;
    font-size: 0.85rem;
    width: 80px;
    text-align: center;
  }
  .searchbar input {
    flex-grow: 1;
    padding: 8px 12px;
    font-size: 0.9rem;
  }
  .searchbar button {
    background: #2a3d56;
    color: white;
    border-radius: 0 30px 30px 0;
    padding: 8px 15px;
    font-size: 1rem;
    transition: background 0.3s;
  }
  .searchbar button:hover {
    background: #1a75ff;
  }
  .button-container {
    display: flex;
    gap: 20px;
    align-items: center;
  }
  .wishlist-button {
    color: white;
    font-size: 1.5rem;
    transition: color 0.3s;
  }
  .wishlist-button:hover {
    color: #ff4757;
  }
  .profile-button {
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    text-decoration: none;
    background: transparent;
    border: 2px solid white;
    transition: all 0.3s;
  }
  .profile-button:hover {
    background: rgba(255, 255, 255, 0.2);
  }.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #2a3d56;
    padding: 15px 30px;
    /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
  }
  .navlogo img {
    height: 100px;
    width: 200px;
  }
  .search-container {
    flex: 1;
    display: flex;
    justify-content: center;
    margin: 0 20px;
  }
  .searchbar {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 30px;
    padding: 2px;
    width: 100%;
    max-width: 600px;
  }
  .category-select {
    background: #2a3d56;
    color: white;
    border-radius: 30px 0 0 30px;
    padding: 10px;
    font-size: 0.85rem;
    width: 80px;
    text-align: center;
  }
  .searchbar input {
    flex-grow: 1;
    padding: 8px 12px;
    font-size: 0.9rem;
  }
  .searchbar button {
    background: #2a3d56;
    color: white;
    border-radius: 0 30px 30px 0;
    padding: 8px;
    font-size: 1rem;
    transition: background 0.3s;
  }
  .searchbar button:hover {
    background: #1a75ff;
  }
  .button-container {
    display: flex;
    gap: 20px;
    align-items: center;
  }
  .wishlist-button {
    color: white;
    font-size: 1.5rem;
    transition: color 0.3s;
  }
  .wishlist-button:hover {
    color: #ff4757;
  }
  .profile-button {
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    text-decoration: none;
    background: transparent;
    border: 2px solid white;
    transition: all 0.3s;
  }
  .profile-button:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .wishlist-icon {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.5rem;
  color: #ff4757;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.8);
  padding: 5px;
  border-radius: 50%;
}

/* Updated button styles */
.btn-primary {
  background-color: #28a745;
  color: var(--white-color);
  transition: all 0.3s ease;
}

.btn-secondary {
  background-color: #dc3545;
  color: var(--white-color);
  transition: all 0.3s ease;
}

.btn-compare {
  background-color: #007bff;
  color: var(--white-color);
  transition: all 0.3s ease;
}

.btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* Loading animation */
.loading-spinner {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Map styles */
#map {
  width: 100%;
  height: 300px;
  border-radius: 12px;
  margin: 1rem 0;
  box-shadow: var(--shadow);
}
  </style>
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
  <header>
    <div class="navbar">
      <div class="navlogo">
        <a href="index.html">
          <img src="Logo1.png" alt="StudXchange">
        </a>
      </div>
      <div class="search-container">
        <form class="searchbar" action="search-results.html" method="GET">
          <select name="category" class="category-select">
            <option value="all">All</option>
            <option value="VIT">VIT</option>
            <option value="COEP">COEP</option>
            <option value="PICT">PICT</option>
            <option value="DYP">DYP</option>
            <option value="PCCOE">PCCOE</option>
          </select>
          <input type="text" name="query" placeholder="Search products...">
          <button type="submit"><i class="fas fa-search"></i></button>
        </form>
      </div>
      <div class="button-container">
        <a class="wishlist-button" href="wishlist.html"><i class="fa-regular fa-heart"></i></a>
        <a class="profile-button" href="PROFILE_FINAL.html"><i class="fas fa-user"></i></a>
      </div>
    </div>
  </header>
  <main>
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
    </div>
    <div class="product-container" id="productContainer">
      <div class="room-layout">
        <div class="product-images room-images">
          <div class="main-image-container">
            <img class="main-image" id="mainImage" alt="Main product image" />
          </div>
          <div class="thumbnails" id="thumbnails"></div>
        </div>

        <div class="product-details room-info">
          <div style="display: flex; justify-content: space-between; align-items: center">
            <h1 class="product-title" id="productTitle"></h1>
            <i class="far fa-heart wishlist-toggle" 
               onclick="toggleWishlist(currentProduct)" 
               style="font-size: 1.5rem; cursor: pointer;"></i>
          </div>
          <div class="price-section">
            <span class="current-price" id="productPrice"></span>
            <span class="original-price" id="productMRP"></span>
          </div>
          
          <!-- Product condition (for regular products) -->
          <div id="productCondition" class="product-condition" style="display: none;"></div>
          
          <!-- Room details section (will be shown only for rooms) -->
          <div id="roomDetailsSection" style="display: none;">
            <div class="room-details" id="roomDetails">
              <!-- Room details will be dynamically populated -->
            </div>
            <div class="amenities-list" id="amenitiesList">
              <!-- Amenities will be dynamically populated -->
            </div>
          </div>
          
          <!-- Map for regular products -->
          <div id="map" style="display: none;"></div>
          
          <div class="action-buttons" id="actionButtons">
            <!-- Buttons will be dynamically populated based on product type -->
          </div>
        </div>
        
        <div class="product-description room-description">
          <h3>Description</h3>
          <p id="productDescription"></p>
        </div>
        
        <!-- Map section -->
        <div class="map-card" id="mapSection" style="display: none;">
          <div class="map-header">
            <h3>Location</h3>
            <div class="map-controls">
              <button class="btn btn-secondary" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
              <button class="btn btn-secondary" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
            </div>
          </div>
          <div id="mapContainer"></div>
        </div>
        
        <div id="notesPreview" style="display: none;">
    <h3 class="section-title"><i class="fas fa-file-alt"></i> Notes Preview</h3>
    <div id="notesContent"></div>
  </div>
  
  <!-- Similar Products Section -->
  <div id="similarProducts" style="display: none;">
    <h3 class="section-title"><i class="fas fa-tags"></i> Similar Products</h3>
    <div class="products-carousel" id="similarProductsCarousel">
      <!-- Similar products will be loaded here -->
    </div>
    <div class="carousel-controls">
      <button class="carousel-control" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <button class="carousel-control" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>
  </div>
        
        <div id="reviewSection" style="display: none; margin-top: 2rem;">
          <h3>Reviews</h3>
          <div id="reviewsList" class="reviews-list"></div>
          <div class="add-review" style="margin-top: 1rem;">
            <h4>Add Review</h4>
            <div class="rating-input" style="margin-bottom: 1rem;">
              <span>Rating: </span>
              <div class="star-rating-selector" id="ratingStars">
                <i class="far fa-star" data-rating="1"></i>
                <i class="far fa-star" data-rating="2"></i>
                <i class="far fa-star" data-rating="3"></i>
                <i class="far fa-star" data-rating="4"></i>
                <i class="far fa-star" data-rating="5"></i>
              </div>
              <input type="hidden" id="ratingInput" value="5">
            </div>
            <textarea id="reviewText" placeholder="Write your review..." style="width: 100%; min-height: 100px; margin-bottom: 1rem;"></textarea>
            <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Buy Now Modal -->
    <div id="buyModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeBuyModal()">&times;</span>
        <h2>Complete Purchase</h2>
        <div class="buyer-info">
          <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="buyerName" readonly />
          </div>
          <div class="input-group">
            <label>Email Address</label>
            <input type="email" id="buyerEmail" readonly />
          </div>
          <div class="input-group">
            <label>Phone Number</label>
            <input type="tel" id="buyerPhone" readonly />
          </div>
          <button class="btn btn-primary" onclick="initiatePurchase()">
            <i class="fab fa-whatsapp"></i> Confirm via WhatsApp
          </button>
        </div>
      </div>
    </div>

    <!-- Compare Modal -->
<div id="compareModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeCompareModal()">&times;</span>
    <h2>Compare Products</h2>
    <input type="text" id="searchBar" placeholder="Search for a product..." oninput="filterProducts()">
    <div class="product-list" id="productList"></div>
    <div class="selected-products">
      <div id="selectedProduct1">Product 1: Not selected</div>
      <div id="selectedProduct2">Product 2: Not selected</div>
    </div>
    <button class="btn btn-primary" onclick="compareProducts()">Compare</button>
    <div id="comparisonTable" class="comparison-table" style="display:none;"></div>
  </div>
</div>

    <!-- Seller Info Modal -->
    <div id="sellerInfoModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeSellerInfoModal()">&times;</span>
        <h2>Seller Information</h2>
        <div id="sellerInfoContent"></div>
        <h3>Sold Products</h3>
        <div id="soldProductsList"></div>
      </div>
    </div>
  </main>

  <footer>
    <p>For any help, contact us at: Studxchange05@gmail.com | Phone: 8857053541</p>
  </footer>

  <script>
    const JSONBIN_API_KEY = "$2a$10$dF64uklTyeOG4.4DwhQH7etxnfGEZirNkdAWk/y.oCmVqPwSEmhCG";
    const JSONBIN_BIN_ID = "67c208a8acd3cb34a8f2a982";
    
    let currentProduct = null;

    let allProducts = [];
  let selectedProduct1 = null;
  let selectedProduct2 = null;


  function updateWishlistIcon() {
    const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    const wishlistIcon = document.querySelector('.wishlist-toggle');
    
    if (!wishlistIcon) {
      console.error("Wishlist icon element not found");
      return;
    }
    
    // Always start with far (outline)
    wishlistIcon.classList.remove('fas', 'far');
    
    if (wishlist.some(item => item.title === currentProduct?.title)) {
      wishlistIcon.classList.add('fas');
      wishlistIcon.style.color = '#ff4757';
    } else {
      wishlistIcon.classList.add('far');
      wishlistIcon.style.color = '#ccc';
    }
  }

  async function toggleWishlist(product) {
    if (!product) {
      console.error("No product provided to toggleWishlist");
      return;
    }
    
    // Find the wishlist icon element
    const wishlistIcon = document.querySelector('.wishlist-toggle');
    if (!wishlistIcon) {
      console.error("Wishlist icon element not found");
      return;
    }
    
    // Add a temporary animation class
    wishlistIcon.classList.add('fa-spin');
    
    try {
      let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
      const index = wishlist.findIndex(item => item.title === product.title);
      
      if (index === -1) {
        // Add to wishlist
        wishlist.push({
          title: product.title,
          price: product.price,
          image: product.images?.[0] || product.image,
          category: product.category
        });
        console.log("Added to wishlist:", product.title);
      } else {
        // Remove from wishlist
        wishlist.splice(index, 1);
        console.log("Removed from wishlist:", product.title);
      }
      
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      
      // Small delay for visual feedback
      setTimeout(() => {
        wishlistIcon.classList.remove('fa-spin');
        updateWishlistIcon();
      }, 500);
    } catch (error) {
      console.error("Error updating wishlist:", error);
      wishlistIcon.classList.remove('fa-spin');
    }
  }

  async function fetchProducts() {
    const data = await fetchData();
    return data.products;
  }

  async function openCompareModal() {
    allProducts = await fetchProducts();
    filterProducts();
    selectedProduct1 = currentProduct;
    document.getElementById('selectedProduct1').textContent = `Product 1: ${currentProduct.title}`;
    document.getElementById('compareModal').style.display = 'flex';
  }

  function closeCompareModal() {
    document.getElementById('compareModal').style.display = 'none';
    selectedProduct1 = null;
    selectedProduct2 = null;
    document.getElementById('selectedProduct1').textContent = 'Product 1: Not selected';
    document.getElementById('selectedProduct2').textContent = 'Product 2: Not selected';
  }

  function filterProducts() {
    const searchQuery = document.getElementById('searchBar').value.toLowerCase();
    const filteredProducts = allProducts.filter(product =>
      product.category === currentProduct.category &&
      product.title.toLowerCase().includes(searchQuery)
    );
    
    const productList = document.getElementById('productList');
    productList.innerHTML = '';
    filteredProducts.forEach(product => {
      const button = document.createElement('button');
      button.textContent = `${product.title} - ₹${product.price}`;
      button.onclick = () => selectProduct(product);
      productList.appendChild(button);
    });
  }

  function selectProduct(product) {
    if (!selectedProduct2) {
      selectedProduct2 = product;
      document.getElementById('selectedProduct2').textContent = `Product 2: ${product.title}`;
    } else {
      alert('You can only compare two products at a time.');
    }
  }

  function compareProducts() {
    if (!selectedProduct1 || !selectedProduct2) {
      alert('Please select two products to compare.');
      return;
    }
    displayComparisonTable(selectedProduct1, selectedProduct2);
  }

  function displayComparisonTable(product1, product2) {
    const table = document.getElementById('comparisonTable');
    table.innerHTML = `
      <h3>Comparison</h3>
      <table class="comparison-table-inner">
        <tr><th>Feature</th><th>${product1.title}</th><th>${product2.title}</th></tr>
        <tr><td>Price</td><td>₹${product1.price}</td><td>₹${product2.price}</td></tr>
        <tr><td>Description</td><td>${product1.description}</td><td>${product2.description}</td></tr>
        <tr><td>Category</td><td>${product1.category}</td><td>${product2.category}</td></tr>
      </table>
    `;
    table.style.display = 'block';
  }

    async function fetchData() {
      try {
        console.log("Fetching data from MongoDB API...");
        
        // Fetch products from MongoDB API
        const productsResponse = await fetch(API_ENDPOINTS.GET_PRODUCTS);
        if (!productsResponse.ok) {
          console.error("Failed to fetch products:", productsResponse.status);
          throw new Error(`Failed to fetch products: ${productsResponse.status}`);
        }
        const products = await productsResponse.json();
        console.log("Products fetched successfully:", products.length);
        
        // Fetch rooms from MongoDB API
        const roomsResponse = await fetch(API_ENDPOINTS.GET_ROOMS);
        if (!roomsResponse.ok) {
          console.error("Failed to fetch rooms:", roomsResponse.status);
          throw new Error(`Failed to fetch rooms: ${roomsResponse.status}`);
        }
        const rooms = await roomsResponse.json();
        console.log("Rooms fetched successfully:", rooms.length);
        
        // Fetch notes from MongoDB API
        const notesResponse = await fetch(API_ENDPOINTS.GET_NOTES);
        if (!notesResponse.ok) {
          console.error("Failed to fetch notes:", notesResponse.status);
          throw new Error(`Failed to fetch notes: ${notesResponse.status}`);
        }
        const notes = await notesResponse.json();
        console.log("Notes fetched successfully:", notes.length);
        
        // Create a composite object similar to the JSONBin structure
        const data = {
          products: [...products, ...notes], // Include notes as products for existing product listing
          rooms: rooms,
          notes: notes, // Separate array for notes
          users: [], // Will be populated on demand
          soldItems: [] // Will be populated on demand
        };
        
        console.log("Combined data structure:", {
          productsCount: data.products.length,
          roomsCount: data.rooms.length,
          notesCount: data.notes.length
        });
        
        // Log sample data for debugging
        if (data.products.length > 0) {
          console.log("Sample product:", data.products[0]);
        }
        if (data.rooms.length > 0) {
          console.log("Sample room:", data.rooms[0]);
        }
        if (data.notes.length > 0) {
          console.log("Sample note:", data.notes[0]);
        }
        
        return data;
      } catch (error) {
        console.error("Failed to load data from MongoDB:", error);
        return { products: [], users: [], soldItems: [], rooms: [], notes: [] };
      }
    }

    // Direct function to fetch a room from MongoDB
    async function fetchRoomDirectly(roomTitle) {
      try {
        console.log("Attempting to fetch room directly from MongoDB:", roomTitle);
        
        // First try by title parameter in query
        const encodedTitle = encodeURIComponent(roomTitle);
        console.log("Making request to: " + API_ENDPOINTS.GET_ROOMS + "?title=" + encodedTitle);
        
        const response = await fetch(API_ENDPOINTS.GET_ROOMS + "?title=" + encodedTitle);
        if (response.ok) {
          const data = await response.json();
          console.log("Response from MongoDB rooms endpoint:", data);
          
          // Check if we got an array or a single object
          if (Array.isArray(data) && data.length > 0) {
            console.log("Found room in array:", data[0]);
            return data[0];
          } else if (data && typeof data === 'object' && data.title) {
            console.log("Found room as object:", data);
            return data;
          }
        } else {
          console.error("Failed to fetch room by query param:", response.status);
        }
        
        // If not found, try direct GET_ROOM_BY_TITLE endpoint
        console.log("Trying specific room endpoint: " + API_ENDPOINTS.GET_ROOM_BY_TITLE + encodedTitle);
        
        const specificResponse = await fetch(API_ENDPOINTS.GET_ROOM_BY_TITLE + encodedTitle);
        if (specificResponse.ok) {
          const roomData = await specificResponse.json();
          console.log("Room data from specific endpoint:", roomData);
          
          if (roomData) {
            return roomData;
          }
        } else {
          console.error("Failed to fetch room from specific endpoint:", specificResponse.status);
        }
        
        console.log("No matching room found in MongoDB");
        return null;
      } catch (error) {
        console.error("Error fetching room directly:", error);
        return null;
      }
    }

    async function loadProductDetails() {
      // Show loading spinner
      document.getElementById('loadingSpinner').style.display = 'flex';
      
      const urlParams = new URLSearchParams(window.location.search);
      const rawParam = urlParams.get('product');
      
      // Try different decoding methods to handle potential double encoding
      const productTitleParam = decodeURIComponent(rawParam);
      const doubleDecodedParam = decodeURIComponent(productTitleParam);
      
      console.log("Loading product/room with:");
      console.log("- Raw param:", rawParam);
      console.log("- Decoded once:", productTitleParam);
      console.log("- Decoded twice:", doubleDecodedParam);

      try {
        const data = await fetchData();
        console.log("Loaded data structure:", Object.keys(data));
        
        // First check in products collection
        let item = null;
        const titleVariations = [
          productTitleParam,
          doubleDecodedParam,
          encodeURIComponent(productTitleParam)
        ];
        
        if (data.products && Array.isArray(data.products)) {
          console.log("Searching in products collection...");
          // Try all title variations
          for (const title of titleVariations) {
            item = data.products.find(p => p.title === title);
            if (item) {
              console.log("Found in products collection with variation:", title);
              break;
            }
          }
        } else {
          console.error("Products collection missing or not an array");
        }
        
        // If not found in products, check in rooms collection
        if (!item && data.rooms) {
          if (Array.isArray(data.rooms)) {
            console.log("Searching in MongoDB 'rooms' collection...");
            console.log("Number of rooms in data:", data.rooms.length);
            // Log all room titles to debug matching issues
            console.log("Available room titles:", data.rooms.map(r => r.title));
            
            // Try all title variations
            for (const title of titleVariations) {
              item = data.rooms.find(r => r.title === title);
              if (item) {
                console.log("Found in rooms collection with variation:", title);
                item.category = 'Room';
                break;
              }
            }
            
            if (!item) {
              // Try case-insensitive search as fallback
              console.log("Trying case-insensitive match...");
              for (const title of titleVariations) {
                item = data.rooms.find(r => 
                  r.title && r.title.toLowerCase() === title.toLowerCase()
                );
                if (item) {
                  console.log("Found with case-insensitive match:", item);
                  item.category = 'Room';
                  break;
                }
              }
            }
          } else {
            console.error("Rooms collection is not an array:", data.rooms);
          }
        } else {
          console.warn("No 'rooms' array found in the data. Key properties:", Object.keys(data));
        }
        
        // Try fetching directly from MongoDB via API if not found
        if (!item) {
          console.log("Item not found in JSONBin data, trying direct MongoDB access...");
          // Try each variation
          for (const title of titleVariations) {
            const roomData = await fetchRoomDirectly(title);
            if (roomData) {
              item = roomData;
              item.category = 'Room';
              console.log("Successfully retrieved room directly from MongoDB:", item);
              break;
            }
          }
        }
        
        // If still not found, try direct API access to get room data
        if (!item) {
          console.log("Item not found, trying API endpoint for room data...");
          try {
            const title = productTitleParam.toLowerCase();
            // Check if we're looking for a room listing
            if (title.includes("hostel") || title.includes("room") || title.includes("pg")) {
              // Make direct API request to server for room data
              const response = await fetch(API_ENDPOINTS.GET_ROOM_BY_TITLE + encodeURIComponent(productTitleParam));
              if (response.ok) {
                const roomData = await response.json();
                console.log("Fetched room data from API:", roomData);
                if (roomData) {
                  item = roomData;
                  item.category = 'Room';
                }
              } else {
                console.error("API room search failed:", response.status);
              }
            }
          } catch (apiError) {
            console.error("Error accessing room API:", apiError);
          }
        }
        
        // Last resort - create a static room for the specific "boys hostel" title
        if (!item && (productTitleParam === "boys hostel" || rawParam === "boys%20hostel" || 
                productTitleParam.toLowerCase().includes("hostel") || productTitleParam.toLowerCase().includes("boys"))) {
          console.log("Creating static data for hostel listing");
          item = {
            title: productTitleParam || "Boys Hostel",
            price: "5000",
            description: "Well-maintained boys hostel near college with all amenities including WiFi, hot water, and security. Monthly rent includes electricity and water charges.",
            hostelName: "College Square Boys Hostel",
            college: "PICT",
            location: "Pune, Maharashtra",
            sellerEmail: "hostelowner@example.com",
            sellerPhone: "9876543210",
            category: "Room",
            amenities: ["WiFi", "Hot Water", "Security", "Cleaning Service", "Power Backup"],
            images: [
              "https://images.pexels.com/photos/1457842/pexels-photo-1457842.jpeg",
              "https://images.pexels.com/photos/271624/pexels-photo-271624.jpeg",
              "https://images.pexels.com/photos/2507016/pexels-photo-2507016.jpeg"
            ]
          };
        }
        
        currentProduct = item;

        if (!currentProduct) {
          console.error("Item not found in products or rooms. Title variations tried:", titleVariations);
          // Try direct debugging of the entire data object
          console.log("Full data object for debugging:", JSON.stringify(data));
          
          // Last resort: Create a temporary room object for testing
          if (confirm('Product not found in database. Would you like to view a temporary room for testing?')) {
            currentProduct = {
              title: productTitleParam,
              price: "5000",
              description: "This is a temporary room for testing. The actual room could not be found in the database.",
              hostelName: "Test Hostel",
              college: "Test College",
              sellerEmail: "test@example.com",
              sellerPhone: "1234567890",
              category: "Room",
              images: ["https://via.placeholder.com/400x300?text=Room+Image"]
            };
            console.log("Created temporary room for testing:", currentProduct);
          } else {
            window.location.href = 'index.html';
            return;
          }
        }

        console.log("Found item:", currentProduct);

        // Update product details
        document.getElementById('productTitle').textContent = currentProduct.title;
        document.getElementById('productPrice').textContent = `₹${currentProduct.price}`;
        
        // Price display differs based on category
        if (currentProduct.category === 'Room') {
          document.getElementById('productMRP').textContent = 'per month';
          document.getElementById('productCondition').style.display = 'none';
        } else if (currentProduct.category === 'Notes') {
          document.getElementById('productMRP').textContent = `Platform Fee: ₹5`;
          document.getElementById('productCondition').style.display = 'none';
          
          // Hide the map section for notes
          document.getElementById('mapSection').style.display = 'none';
          
          // Create a PDF viewer section if pdfUrl exists
          if (currentProduct.pdfUrl) {
            const pdfSection = document.createElement('div');
            pdfSection.className = 'product-section';
            pdfSection.innerHTML = `
              <h3>Buy & Download PDF</h3>
              <div class="pdf-container">
                <p>Scan the QR code or use UPI ID to pay ₹5 for this note:</p>
                <img src="/public/upi-qr-placeholder.png" alt="UPI QR Code" style="width:160px;height:160px;display:block;margin:0 auto 10px;" />
                <p style="text-align:center;font-size:14px;">UPI ID: <b>your-upi-id@okhdfcbank</b></p>
                <button id="showTxnInputBtn" class="pdf-button">I have paid</button>
                <div id="txnInputSection" style="display:none;margin-top:10px;">
                  <input type="text" id="txnIdInput" placeholder="Enter UPI Transaction ID" style="padding:8px;width:80%;border-radius:5px;border:1px solid #ccc;" />
                  <input type="email" id="buyerEmailInput" placeholder="Your Email" style="padding:8px;width:80%;margin-top:5px;border-radius:5px;border:1px solid #ccc;" />
                  <button id="submitTxnBtn" class="pdf-button" style="margin-top:8px;">Submit</button>
                  <div id="txnStatus" style="margin-top:10px;color:green;display:none;"></div>
                </div>
              </div>
            `;
            const productInfoSection = document.querySelector('.product-info');
            productInfoSection.parentNode.insertBefore(pdfSection, productInfoSection.nextSibling);
            
            const style = document.createElement('style');
            style.textContent = `
              .pdf-container { padding: 15px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px; }
              .pdf-button { display: inline-flex; align-items: center; gap: 8px; background: #2a3d56; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; margin-top: 10px; transition: background 0.3s; border: none; cursor: pointer; }
              .pdf-button:hover { background: #1a75ff; }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
              const showTxnInputBtn = document.getElementById('showTxnInputBtn');
              const txnInputSection = document.getElementById('txnInputSection');
              const submitTxnBtn = document.getElementById('submitTxnBtn');
              const txnStatus = document.getElementById('txnStatus');
              if (showTxnInputBtn) {
                showTxnInputBtn.onclick = function() {
                  txnInputSection.style.display = 'block';
                };
              }
              if (submitTxnBtn) {
                submitTxnBtn.onclick = async function() {
                  const txnId = document.getElementById('txnIdInput').value.trim();
                  const email = document.getElementById('buyerEmailInput').value.trim();
                  if (!txnId || !email) {
                    alert('Please enter both Transaction ID and your Email.');
                    return;
                  }
                  txnStatus.style.display = 'block';
                  txnStatus.textContent = 'Submitting your payment request...';
                  const res = await fetch('/api/payment-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      email,
                      noteTitle: currentProduct.title,
                      pdfUrl: currentProduct.pdfUrl,
                      transactionId: txnId
                    })
                  });
                  const data = await res.json();
                  if (data.success) {
                    txnStatus.textContent = 'Payment request submitted! You will receive the download link by email after admin approval.';
                  } else {
                    txnStatus.textContent = 'There was an error submitting your request.';
                  }
                };
              }
            }, 500);
          }
        } else {
          document.getElementById('productMRP').textContent = `MRP: ₹${(currentProduct.price * 1.2).toFixed(2)}`;
          
          // Show condition text for regular products
          const conditionText = document.getElementById('productCondition');
          conditionText.style.display = 'block';
          conditionText.textContent = `Condition: ${currentProduct.condition || 'Used'}`;
        }
        
        // Set main image
        const mainImage = document.getElementById('mainImage');
        const primaryImage = currentProduct.images?.[0] || currentProduct.image || 'placeholder.jpg';
        mainImage.src = primaryImage;

        // Create thumbnails
        const thumbnailsContainer = document.getElementById('thumbnails');
        thumbnailsContainer.innerHTML = '';
        
        const imagesToShow = currentProduct.images?.length ? 
          currentProduct.images : 
          (currentProduct.image ? [currentProduct.image] : []);

        imagesToShow.forEach(imgUrl => {
          const thumb = document.createElement('img');
          thumb.src = imgUrl;
          thumb.className = 'thumbnail';
          thumb.alt = "Product thumbnail";
          thumb.onclick = () => { mainImage.src = imgUrl; };
          thumbnailsContainer.appendChild(thumb);
        });

        // Update action buttons based on product type
        const actionButtons = document.getElementById('actionButtons');
        actionButtons.innerHTML = '';

        if (currentProduct.category === 'Room') {
          // For room listings - only the Contact Owner button
          actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="contactOwner()">
              <i class="fab fa-whatsapp"></i> Contact Owner
            </button>
          `;
          
          // Show room details
          const roomDetailsSection = document.getElementById('roomDetailsSection');
          roomDetailsSection.style.display = 'block';
          
          // Hide map for room listings
          document.getElementById('map').style.display = 'none';
          
          // Populate room details
          const roomDetails = document.getElementById('roomDetails');
          roomDetails.innerHTML = '';
          
          // Add hostel name
          if (currentProduct.hostelName) {
            const hostelNameDetail = document.createElement('div');
            hostelNameDetail.className = 'detail-item';
            hostelNameDetail.innerHTML = `
              <i class="fas fa-building"></i> 
              <span>${currentProduct.hostelName}</span>
            `;
            roomDetails.appendChild(hostelNameDetail);
          }
          
          // Add college
          if (currentProduct.college) {
            const collegeDetail = document.createElement('div');
            collegeDetail.className = 'detail-item';
            collegeDetail.innerHTML = `
              <i class="fas fa-graduation-cap"></i> 
              <span>${currentProduct.college}</span>
            `;
            roomDetails.appendChild(collegeDetail);
          }
          
          // Add location
          if (currentProduct.location) {
            const locationDetail = document.createElement('div');
            locationDetail.className = 'detail-item';
            locationDetail.innerHTML = `
              <i class="fas fa-map-marker-alt"></i> 
              <span>${currentProduct.location}</span>
            `;
            roomDetails.appendChild(locationDetail);
          }
          
          // Display amenities if available
          const amenitiesList = document.getElementById('amenitiesList');
          amenitiesList.innerHTML = '';
          
          if (currentProduct.amenities && currentProduct.amenities.length > 0) {
            // Map of amenity names to icons
            const amenityIcons = {
              'WiFi': 'fa-wifi',
              'Hot Water': 'fa-hot-tub',
              'AC': 'fa-snowflake',
              'Non-AC': 'fa-fan',
              'Mess': 'fa-utensils',
              'Security': 'fa-shield-alt',
              'Laundry': 'fa-tshirt',
              'Cleaning': 'fa-broom',
              'Parking': 'fa-parking',
              'TV': 'fa-tv',
              'Refrigerator': 'fa-refrigerator',
              'Study Table': 'fa-table',
              'Cupboard': 'fa-door-closed',
              'Power Backup': 'fa-bolt',
              'Gym': 'fa-dumbbell',
              'Cleaning Service': 'fa-broom'
            };
            
            currentProduct.amenities.forEach(amenity => {
              const amenityBadge = document.createElement('div');
              amenityBadge.className = 'amenity-badge';
              
              // Choose the right icon or default to fa-check
              const iconClass = amenityIcons[amenity] || 'fa-check';
              
              amenityBadge.innerHTML = `
                <i class="fas ${iconClass}"></i>
                <span>${amenity}</span>
              `;
              amenitiesList.appendChild(amenityBadge);
            });
          }
          
          document.getElementById('reviewSection').style.display = 'block';
          loadReviews();
          
          // Update seller info modal title for rooms
          document.querySelector('#sellerInfoModal h2').textContent = 'Hostel Information';
        } else {
          // For regular products - remove chat button, update styling
          actionButtons.innerHTML = `
            <button class="btn btn-primary" onclick="openBuyModal()">
              <i class="fas fa-shopping-cart"></i> Buy Now
            </button>
            <button class="btn btn-secondary" onclick="showSellerInfo()">
              <i class="fas fa-user"></i> Seller Info
            </button>
            <button class="btn btn-compare" onclick="openCompareModal()">
              <i class="fas fa-exchange-alt"></i> Compare
            </button>
          `;
          document.getElementById('reviewSection').style.display = 'none';
          document.getElementById('roomDetailsSection').style.display = 'none';
          
          // Reset seller info modal title for regular products
          document.querySelector('#sellerInfoModal h2').textContent = 'Seller Information';
          
          // Initialize map for regular products
          initializeMap();
        }

        updateWishlistIcon();
        
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
      } catch (error) {
        console.error('Error loading product:', error);
        alert('Error loading product details');
        window.location.href = 'index.html';
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    }

    async function showSellerInfo() {
      try {
        if (!currentProduct || !currentProduct.sellerEmail) {
          console.error("No seller email available for this product");
          alert("Seller information not available");
          return;
        }
        
        console.log("Fetching seller info for email:", currentProduct.sellerEmail);
        
        // Build seller info content
        const sellerInfoContent = document.getElementById('sellerInfoContent');
        sellerInfoContent.innerHTML = '<p>Loading seller information...</p>';
        
        // Show the modal while loading data
        document.getElementById('sellerInfoModal').style.display = 'flex';
        
        // For room listings - display hostel information
        if (currentProduct.category === 'Room') {
          sellerInfoContent.innerHTML = `
            <div class="modal-body">
              <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Hostel Name:</strong> ${currentProduct.hostelName || 'Not available'}
                </li>
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">College:</strong> ${currentProduct.college || 'Not specified'}
                </li>
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Owner:</strong> ${currentProduct.ownerName || 'Not available'}
                </li>
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Contact:</strong> ${currentProduct.sellerPhone || currentProduct.contact1 || 'Not provided'}
                </li>
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Email:</strong> ${currentProduct.sellerEmail || 'Not provided'}
                </li>
                ${currentProduct.amenities ? `
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Amenities:</strong> ${currentProduct.amenities.join(', ')}
                </li>` : ''}
                ${currentProduct.location ? `
                <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <strong style="color: var(--primary-color);">Location:</strong> ${currentProduct.location}
                </li>` : ''}
              </ul>
            </div>
          `;
          
          // Hide sold products section for rooms
          document.querySelector('#sellerInfoModal h3').style.display = 'none';
          document.getElementById('soldProductsList').style.display = 'none';
        } else {
          // For regular products, show seller info from user database
          try {
            // Try to fetch sold items by this seller
            const soldItemsResponse = await fetch(API_ENDPOINTS.GET_SOLD_ITEMS + "?sellerEmail=" + encodeURIComponent(currentProduct.sellerEmail));
            let soldItems = [];
            
            if (soldItemsResponse.ok) {
              soldItems = await soldItemsResponse.json();
              console.log("Sold items fetched:", soldItems);
            } else {
              console.error("Failed to fetch sold items:", soldItemsResponse.status);
            }
            
            sellerInfoContent.innerHTML = `
              <div class="modal-body">
                <ul style="list-style: none; padding: 0;">
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Name:</strong> ${currentProduct.sellerName || 'Not available'}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Email:</strong> ${currentProduct.sellerEmail}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Phone:</strong> ${currentProduct.sellerPhone || 'Not provided'}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">College:</strong> ${currentProduct.college || 'Not specified'}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Total Items Sold:</strong> ${soldItems.length}
                  </li>
                </ul>
              </div>
            `;
            
            // Show sold products for regular products
            document.querySelector('#sellerInfoModal h3').style.display = 'block';
            document.getElementById('soldProductsList').style.display = 'block';
            
            // Build sold products list
            const soldProductsList = document.getElementById('soldProductsList');
            soldProductsList.innerHTML = soldItems.length > 0 
              ? soldItems.map(item => `
                  <div style="padding: 1rem; background: #f8f9fa; margin: 0.75rem 0; border-radius: 8px; border: 1px solid #ddd;">
                    <strong style="color: var(--primary-color);">${item.title}</strong> - ₹${item.price}
                    ${item.image ? `<img src="${item.image}" alt="${item.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-left: 10px; float: right;">` : ''}
                  </div>
                `).join('')
              : '<p style="text-align: center; color: #666;">No items sold yet</p>';
          } catch (error) {
            console.error("Error fetching seller data:", error);
            sellerInfoContent.innerHTML = `
              <div class="modal-body">
                <ul style="list-style: none; padding: 0;">
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Name:</strong> ${currentProduct.sellerName || 'Not available'}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Email:</strong> ${currentProduct.sellerEmail}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Phone:</strong> ${currentProduct.sellerPhone || 'Not provided'}
                  </li>
                  <li style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: var(--primary-color);">Error:</strong> Could not load additional seller data
                  </li>
                </ul>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading seller/hostel info:', error);
        document.getElementById('sellerInfoContent').innerHTML = '<p style="text-align: center; color: #dc3545;">Failed to load seller information. Please try again.</p>';
      }
    }

    function closeSellerInfoModal() {
      document.getElementById('sellerInfoModal').style.display = 'none';
    }

    function openBuyModal() {
      const user = JSON.parse(localStorage.getItem('currentUser'));
      if (!user) {
        alert('Please sign in to continue');
        window.location.href = 'signuppage.html';
        return;
      }

      // Check if the product is a note and has a PDF URL
      if (currentProduct && currentProduct.category === 'Notes' && currentProduct.pdfUrl) {
        // For notes with PDF, redirect directly to download
        window.location.href = `${API_ENDPOINTS.GET_NOTE}/${currentProduct._id}?download=true`;
        return;
      }

      // For other products, show the buy modal
      document.getElementById('buyerName').value = user.name;
      document.getElementById('buyerEmail').value = user.email;
      document.getElementById('buyerPhone').value = user.phone || 'Not provided';
      document.getElementById('buyModal').style.display = 'flex';
    }

    function initiatePurchase() {
      if (!currentProduct) return;

      const sellerPhone = currentProduct.sellerPhone;
      if (!sellerPhone) {
        alert('Seller contact information not available');
        return;
      }

      const user = JSON.parse(localStorage.getItem('currentUser'));
      if (!user) return;

      const formattedPhone = sellerPhone.startsWith('+') ? sellerPhone : `+91${sellerPhone}`;
      const message = encodeURIComponent(
        `*Purchase Request:*\n\n` +
        `I want to buy: *${currentProduct.title}*\n` +
        `Price: ₹${currentProduct.price}\n\n` +
        `*My Details*\n` +
        `Name: ${user.name}\n` +
        `Email: ${user.email}\n` +
        `Phone: ${user.phone || 'Not provided'}\n\n` +
        `Please confirm availability and payment details.`
      );

      const whatsappURL = `https://wa.me/${formattedPhone}?text=${message}`;
      window.open(whatsappURL, '_blank');
      closeBuyModal();
    }

    function closeBuyModal() {
      document.getElementById('buyModal').style.display = 'none';
    }

    

    window.onclick = (event) => {
      const modals = ['buyModal', 'sellerInfoModal', 'chatModal', 'compareModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    };
    const JSONBIN_CHAT_ID = "67c20bc8acd3cb34a8f2aaf6";


function openChatModal() {
    document.getElementById("chatModal").style.display = "flex";
    loadChatMessages();
}

function closeChatModal() {
    document.getElementById("chatModal").style.display = "none";
}

async function loadChatMessages() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
            headers: { 'X-Master-Key': JSONBIN_API_KEY }
        });
        const data = await response.json();
        const messages = data.record.messages || [];

        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = "";
        messages.forEach((msg, index) => {
            const messageElement = document.createElement("div");
            messageElement.className = "chat-message";
            messageElement.textContent = msg.text;

            const deleteIcon = document.createElement("span");
            deleteIcon.className = "chat-delete";
            deleteIcon.textContent = "✖";
            deleteIcon.onclick = () => deleteMessage(index);

            messageElement.appendChild(deleteIcon);
            chatBox.appendChild(messageElement);
        });
    } catch (error) {
        console.error("Failed to load messages:", error);
    }
}

async function sendMessage() {
    const messageInput = document.getElementById("chatMessage");
    const messageText = messageInput.value.trim();
    if (!messageText) return;

    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
            headers: { 'X-Master-Key': JSONBIN_API_KEY }
        });
        const data = await response.json();
        const messages = data.record.messages || [];

        messages.push({ text: messageText });

        const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify({ messages })
        });

        if (updateResponse.ok) {
            messageInput.value = "";
            loadChatMessages();
        } else {
            alert("Failed to send message.");
        }
    } catch (error) {
        console.error("Error sending message:", error);
    }
}

async function deleteMessage(index) {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
            headers: { 'X-Master-Key': JSONBIN_API_KEY }
        });
        const data = await response.json();
        const messages = data.record.messages || [];

        messages.splice(index, 1);

        await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': JSONBIN_API_KEY
            },
            body: JSON.stringify({ messages })
        });

        loadChatMessages();
    } catch (error) {
        console.error("Error deleting message:", error);
    }
}
document.addEventListener('DOMContentLoaded', () => {
  loadProductDetails();
  
  // Initialize chat message input
  document.getElementById('chatMessage').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
});

    document.addEventListener('DOMContentLoaded', loadProductDetails);
// Call this after loading product details
document.addEventListener('DOMContentLoaded', () => {
  loadProductDetails().then(updateWishlistIcon);
});

function contactOwner() {
  if (!currentProduct) {
    console.error("No product data available");
    return;
  }

  const sellerPhone = currentProduct.sellerPhone || currentProduct.contact1;
  if (!sellerPhone) {
    alert('Owner contact information not available');
    return;
  }

  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) {
    alert('Please sign in to contact the owner');
    window.location.href = 'login.html';
    return;
  }

  // Show loading animation on button
  const contactButton = document.querySelector('button.btn-primary');
  if (contactButton) {
    const originalText = contactButton.innerHTML;
    contactButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening WhatsApp...';
    contactButton.disabled = true;
    
    setTimeout(() => {
      contactButton.innerHTML = originalText;
      contactButton.disabled = false;
    }, 2000);
  }

  const formattedPhone = sellerPhone.startsWith('+') ? sellerPhone : `+91${sellerPhone}`;
  const message = encodeURIComponent(
    `*Room Inquiry:*\n\n` +
    `I am interested in: *${currentProduct.title}*\n` +
    `Hostel: ${currentProduct.hostelName || 'Not specified'}\n` +
    `Rent: ₹${currentProduct.price}/month\n` +
    `Location: ${currentProduct.location || 'Not specified'}\n` +
    `College: ${currentProduct.college || 'Not specified'}\n\n` +
    `*My Details*\n` +
    `Name: ${user.name}\n` +
    `Email: ${user.email}\n` +
    `Phone: ${user.phone || 'Not provided'}\n\n` +
    `Please provide more information about the room availability.`
  );

  const whatsappURL = `https://wa.me/${formattedPhone}?text=${message}`;
  window.open(whatsappURL, '_blank');
}

async function loadReviews() {
  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    const data = await response.json();
    const reviews = data.record.reviews || [];
    
    // Use room title for matching if id is not available
    const roomId = currentProduct.id || currentProduct.title;
    const roomReviews = reviews.filter(review => 
      (review.roomId === roomId) || (review.roomTitle === currentProduct.title)
    );
    
    const reviewsList = document.getElementById('reviewsList');
    reviewsList.innerHTML = '';

    if (roomReviews.length > 0) {
      const averageRating = roomReviews.reduce((acc, review) => acc + review.rating, 0) / roomReviews.length;
      const avgRatingDiv = document.createElement('div');
      avgRatingDiv.className = 'average-rating';
      avgRatingDiv.innerHTML = `
        Average Rating: ${averageRating.toFixed(1)}
        <span class="star-rating">${'★'.repeat(Math.round(averageRating))}${'☆'.repeat(5 - Math.round(averageRating))}</span>
      `;
      reviewsList.appendChild(avgRatingDiv);

      roomReviews.forEach(review => {
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review-item';
        reviewElement.innerHTML = `
          <div class="review-header">
            <strong>${review.userName}</strong>
            <span class="review-rating">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span>
          </div>
          <div class="review-content">${review.text}</div>
        `;
        reviewsList.appendChild(reviewElement);
      });
    } else {
      reviewsList.innerHTML = '<p>No reviews yet. Be the first to review!</p>';
    }
  } catch (error) {
    console.error('Error loading reviews:', error);
  }
}

async function submitReview() {
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) {
    alert('Please sign in to submit a review');
    window.location.href = 'signuppage.html';
    return;
  }

  const rating = parseInt(document.getElementById('ratingInput').value);
  const text = document.getElementById('reviewText').value.trim();

  if (!text) {
    alert('Please write a review');
    return;
  }

  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    const data = await response.json();
    const reviews = data.record.reviews || [];

    reviews.push({
      roomId: currentProduct.id || currentProduct.title, // Use title as fallback if id not available
      roomTitle: currentProduct.title,
      userId: user.id,
      userName: user.name,
      rating,
      text,
      timestamp: new Date().toISOString()
    });

    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_API_KEY
      },
      body: JSON.stringify({ ...data.record, reviews })
    });

    document.getElementById('reviewText').value = '';
    document.getElementById('ratingInput').value = '5';
    loadReviews();
    
    alert('Your review has been submitted. Thank you!');
  } catch (error) {
    console.error('Error submitting review:', error);
    alert('Failed to submit review. Please try again.');
  }
}

// Add event listener for star rating selection
document.addEventListener('DOMContentLoaded', function() {
  // Setup star rating
  const ratingStars = document.querySelectorAll('#ratingStars i');
  const ratingInput = document.getElementById('ratingInput');
  
  ratingStars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = this.getAttribute('data-rating');
      ratingInput.value = rating;
      
      // Update active stars
      ratingStars.forEach(s => {
        const starRating = s.getAttribute('data-rating');
        if (starRating <= rating) {
          s.className = 'fas fa-star active';
        } else {
          s.className = 'far fa-star';
        }
      });
    });
    
    // Hover effects
    star.addEventListener('mouseover', function() {
      const rating = this.getAttribute('data-rating');
      
      ratingStars.forEach(s => {
        const starRating = s.getAttribute('data-rating');
        if (starRating <= rating) {
          s.className = 'fas fa-star active';
        } else {
          s.className = 'far fa-star';
        }
      });
    });
    
    // Reset to selected rating on mouseout
    star.addEventListener('mouseout', function() {
      const selectedRating = ratingInput.value;
      
      ratingStars.forEach(s => {
        const starRating = s.getAttribute('data-rating');
        if (starRating <= selectedRating) {
          s.className = 'fas fa-star active';
        } else {
          s.className = 'far fa-star';
        }
      });
    });
  });
  
  // Initialize with 5 stars selected
  ratingStars.forEach(s => {
    s.className = 'fas fa-star active';
  });
  
  // Other DOM initialization code...
});

// Use a different variable name to avoid potential conflicts
let productMap = null;

// Completely rewritten map initialization function
function initializeMap() {
  // Don't initialize map for room listings
  if (!currentProduct || currentProduct.category === 'Room') {
    return;
  }
  
  console.log("Initializing map for product:", currentProduct.title);
  
  try {
    // Get and configure the map container
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.error("Map container not found");
      return;
    }
    
    // Make sure the container is visible and has height
    mapContainer.style.display = 'block';
    mapContainer.style.height = '300px';
    
    // Default coordinates (Pune)
    let lat = 18.5204;
    let lng = 73.8567;
    
    // Try to get coordinates from product data in different possible formats
    if (currentProduct.coordinates) {
      // If coordinates are stored directly
      if (typeof currentProduct.coordinates.lat !== 'undefined' && 
          typeof currentProduct.coordinates.lon !== 'undefined') {
        lat = parseFloat(currentProduct.coordinates.lat);
        lng = parseFloat(currentProduct.coordinates.lon);
        console.log("Using stored coordinates:", lat, lng);
      } else if (typeof currentProduct.coordinates.latitude !== 'undefined' && 
                 typeof currentProduct.coordinates.longitude !== 'undefined') {
        lat = parseFloat(currentProduct.coordinates.latitude);
        lng = parseFloat(currentProduct.coordinates.longitude);
        console.log("Using stored lat/long coordinates:", lat, lng);
      }
    } else if (currentProduct.location) {
      console.log("Product has location but no coordinates:", currentProduct.location);
      // For testing - check if location has latitude,longitude format
      const locMatch = currentProduct.location.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
      if (locMatch) {
        lat = parseFloat(locMatch[1]);
        lng = parseFloat(locMatch[2]);
        console.log("Extracted coordinates from location string:", lat, lng);
      }
    }
    
    // Verify coordinates are valid numbers
    if (isNaN(lat) || isNaN(lng)) {
      console.error("Invalid coordinates:", lat, lng);
      lat = 18.5204; // Reset to default
      lng = 73.8567;
    }
    
    // Wait for the DOM to be fully rendered
    setTimeout(() => {
      try {
        // Check if Leaflet is available
        if (typeof L === 'undefined') {
          console.error("Leaflet is not loaded");
          showMapError(mapContainer, "Map library not available");
          return;
        }
        
        // Remove any existing map
        if (productMap && productMap.remove) {
          productMap.remove();
          productMap = null;
        }
        
        console.log("Creating map with coordinates:", lat, lng);
        
        // Create the map
        productMap = L.map(mapContainer.id).setView([lat, lng], 13);
        
        // Add the tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap contributors'
        }).addTo(productMap);
        
        // Add a marker at the location
        const marker = L.marker([lat, lng]).addTo(productMap);
        
        // Add a popup to the marker
        marker.bindPopup(`
          <strong>${currentProduct.title}</strong><br>
          ${currentProduct.location || 'Location'}
        `).openPopup();
        
        // Force map to update its size (solves rendering issues)
        setTimeout(() => {
          if (productMap) productMap.invalidateSize();
        }, 300);
        
        console.log("Map initialized successfully");
        
        // Add zoom controls
        const zoomIn = document.createElement('button');
        zoomIn.innerHTML = '<i class="fas fa-plus"></i>';
        zoomIn.className = 'map-control';
        zoomIn.style = 'position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: none; width: 30px; height: 30px; border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.3);';
        zoomIn.onclick = () => productMap.zoomIn();
        mapContainer.appendChild(zoomIn);
        
        const zoomOut = document.createElement('button');
        zoomOut.innerHTML = '<i class="fas fa-minus"></i>';
        zoomOut.className = 'map-control';
        zoomOut.style = 'position: absolute; top: 50px; right: 10px; z-index: 1000; background: white; border: none; width: 30px; height: 30px; border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.3);';
        zoomOut.onclick = () => productMap.zoomOut();
        mapContainer.appendChild(zoomOut);
        
      } catch (mapError) {
        console.error("Error creating map:", mapError);
        showMapError(mapContainer, "Failed to initialize map");
      }
    }, 500); // Wait for 500ms to ensure DOM is ready
    
  } catch (error) {
    console.error("Failed to initialize map:", error);
    const mapContainer = document.getElementById('map');
    if (mapContainer) {
      showMapError(mapContainer, "Error loading map");
    }
  }
}

// Show friendly error message when map fails to load
function showMapError(container, message) {
  if (!container) return;
  
  container.innerHTML = `
    <div style="padding: 20px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #f8f9fa; border-radius: 12px;">
      <p><i class="fas fa-map-marker-alt" style="font-size: 2rem; color: #dc3545; margin-bottom: 10px;"></i></p>
      <p style="font-weight: bold; margin-bottom: 5px;">${message}</p>
      <p style="color: #666;">${currentProduct?.location || 'Location information unavailable'}</p>
    </div>
  `;
}

// Listen for window resize to recalculate map size
window.addEventListener('resize', function() {
  if (productMap) {
    setTimeout(() => productMap.invalidateSize(), 100);
  }
});

// Preview Before Buy for Notes
if (currentProduct.category === 'Notes') {
  document.getElementById('productMRP').textContent = `Platform Fee: ₹5`;
  document.getElementById('productCondition').style.display = 'none';
  document.getElementById('mapSection').style.display = 'none';
  
  // Add Download PDF button to action buttons
  const actionButtons = document.getElementById('actionButtons');
  const downloadButton = document.createElement('button');
  downloadButton.className = 'btn btn-primary';
  downloadButton.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
  downloadButton.onclick = downloadPdf;
  actionButtons.appendChild(downloadButton);
  
  if (currentProduct.previewUrl) {
    const previewSection = document.createElement('div');
    previewSection.className = 'product-section';
    previewSection.innerHTML = `
      <h3>Preview (First Page)</h3>
      <div class="pdf-preview-container">
        <iframe src="${currentProduct.previewUrl}" width="100%" height="400" style="border:1px solid #ccc;border-radius:6px;background:#fff;"></iframe>
        <div style="margin-top:8px;color:#888;font-size:13px;">Preview is watermarked and only shows the first page.</div>
      </div>
    `;
    const productInfoSection = document.querySelector('.product-info');
    productInfoSection.parentNode.insertBefore(previewSection, productInfoSection);
    const style = document.createElement('style');
    style.textContent = `.pdf-preview-container { margin-bottom: 18px; }`;
    document.head.appendChild(style);
  }
}

// Add downloadPdf function optimized for Vercel deployment
async function downloadPdf() {
  try {
    console.log("Download PDF button clicked");
    
    // Check if the product has a pdfUrl
    if (!currentProduct || !currentProduct.pdfUrl) {
      alert('PDF not available for this product');
      return;
    }
    
    // Show loading indicator
    const downloadButton = document.querySelector('#actionButtons .btn-primary');
    const originalButtonText = downloadButton.innerHTML;
    downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing download...';
    downloadButton.disabled = true;
    
    // Extract the filename from the URL
    const pdfUrl = currentProduct.pdfUrl;
    console.log("PDF URL:", pdfUrl);
    
    // Check if this is a metadata URL (for chunked files)
    if (pdfUrl.includes('_metadata.json')) {
      // This is a chunked file, we need to download and combine all chunks
      downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching metadata...';
      
      // Fetch the metadata file
      const metadataResponse = await fetch(pdfUrl);
      if (!metadataResponse.ok) {
        throw new Error(`Failed to fetch metadata: ${metadataResponse.status}`);
      }
      
      const metadata = await metadataResponse.json();
      console.log("PDF metadata:", metadata);
      
      // Create progress indicator
      const totalChunks = metadata.totalChunks;
      let downloadedChunks = 0;
      
      // Download all chunks
      const chunkPromises = metadata.chunkUrls.map(async (chunkUrl, index) => {
        // Fetch this chunk
        const chunkResponse = await fetch(chunkUrl);
        if (!chunkResponse.ok) {
          throw new Error(`Failed to fetch chunk ${index}: ${chunkResponse.status}`);
        }
        
        // Get the chunk data as array buffer
        const chunkData = await chunkResponse.arrayBuffer();
        
        // Update progress
        downloadedChunks++;
        const progress = Math.round((downloadedChunks / totalChunks) * 100);
        downloadButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Downloading: ${progress}%`;
        
        return chunkData;
      });
      
      // Wait for all chunks to download
      const chunkDataArray = await Promise.all(chunkPromises);
      
      // Combine all chunks into a single blob
      downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assembling PDF...';
      
      // Create a single array buffer from all chunks
      const totalSize = chunkDataArray.reduce((size, chunk) => size + chunk.byteLength, 0);
      const combinedBuffer = new Uint8Array(totalSize);
      
      let offset = 0;
      chunkDataArray.forEach(chunk => {
        combinedBuffer.set(new Uint8Array(chunk), offset);
        offset += chunk.byteLength;
      });
      
      // Create a blob from the combined buffer
      const blob = new Blob([combinedBuffer], { type: metadata.mimeType || 'application/pdf' });
      
      // Create a download link
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = currentProduct.title ? `${currentProduct.title}.pdf` : metadata.originalFilename;
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        URL.revokeObjectURL(downloadUrl);
        document.body.removeChild(a);
      }, 100);
    } 
    // Regular Supabase URL (non-chunked file)
    else if (pdfUrl.includes('supabase')) {
      // This is a Supabase URL, we can use the Supabase client to download it
      downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading file...';
      
      // Get the file path from the URL (everything after the bucket name)
      const urlParts = pdfUrl.split('pdfs/');
      if (urlParts.length < 2) {
        throw new Error('Invalid PDF URL format');
      }
      
      const filePath = urlParts[1];
      console.log("Downloading file from path:", filePath);
      
      // For Vercel deployment, avoid using the Supabase client directly for large files
      // Instead, use fetch to download the file directly from the URL
      const response = await fetch(pdfUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch PDF: ${response.status}`);
      }
      
      const blob = await response.blob();
      
      // Create a download link
      const downloadUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = currentProduct.title ? `${currentProduct.title}.pdf` : filePath.split('/').pop();
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        URL.revokeObjectURL(downloadUrl);
        document.body.removeChild(a);
      }, 100);
    } 
    // Direct URL (not Supabase)
    else {
      // This is a direct URL, we can download it directly
      downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading file...';
      
      const a = document.createElement('a');
      a.href = pdfUrl;
      a.download = currentProduct.title ? `${currentProduct.title}.pdf` : 'notes.pdf';
      a.target = '_blank';
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(a);
      }, 100);
    }
    
    console.log("PDF download initiated successfully");
  } catch (error) {
    console.error("Error downloading PDF:", error);
    alert(`Failed to download PDF: ${error.message || 'Unknown error'}. Please try again later.`);
  } finally {
    // Reset button state
    const downloadButton = document.querySelector('#actionButtons .btn-primary');
    if (downloadButton) {
      downloadButton.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
      downloadButton.disabled = false;
    }
  }
}

</script>
 

</body>
</html>