<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - StudXchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" />
  <script src="js/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="js/db-config.js"></script>
  <style>
    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
    }
    header {
      background-color: #2a3d56;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .account-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .account-header h1 {
      font-size: 24px;
      color: #2a3d56;
    }
    .account-actions button {
      background-color: #2a3d56;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .account-actions button:hover {
      background-color: #4d6a88;
    }
    .profile-info, .order-history, .sold-items, .settings {
      margin-bottom: 20px;
    }
    .profile-info h2, .order-history h2, .sold-items h2, .settings h2 {
      font-size: 22px;
      color: #2a3d56;
      margin-bottom: 10px;
    }
    .profile-item {
      margin: 10px 0;
    }
    .profile-item strong {
      color: #2a3d56;
    }
    .order-history ul, .sold-items ul {
      list-style-type: none;
      padding: 0;
    }
    .order-history li, .sold-items li {
      margin: 8px 0;
    }
    .settings button {
      background-color: #2a3d56;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 8px;
      margin-right: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .settings button:hover {
      background-color: #4d6a88;
    }
    .phone-button {
      margin-left: 10px;
      padding: 5px 10px;
      background: #2a3d56;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .listed-items {
      margin-bottom: 30px;
    }
    .listed-item {
      display: flex;
      align-items: center;
      padding: 20px;
      background: #f8f9fb;
      border-radius: 12px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .listed-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .item-image {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 20px;
      transition: transform 0.5s ease;
    }
    .listed-item:hover .item-image {
      transform: scale(1.05);
    }
    .item-details {
      flex-grow: 1;
      padding-right: 15px;
    }
    .item-details h3 {
      color: #2a3d56;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .item-details p {
      color: #666;
      margin-bottom: 5px;
    }
    .item-details .price {
      color: #1a75ff;
      font-weight: bold;
      font-size: 16px;
    }
    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 120px;
    }
    .sold-btn, .delete-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: white;
    }
    .sold-btn {
      background-color: #28a745 !important;
      border: 1px solid #218838;
    }
    .sold-btn:hover {
      background-color: #218838 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .delete-btn {
      background-color: #dc3545 !important;
      border: 1px solid #c82333;
    }
    .delete-btn:hover {
      background-color: #c82333 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      transition: opacity 0.2s;
    }
    .modal-content {
      background: #fff;
      margin: 40px auto;
      padding: 32px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(42,61,86,0.14);
      width: 95%;
      max-width: 480px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: modalPop 0.2s cubic-bezier(.4,2,.6,1);
    }
    @keyframes modalPop {
      0% { transform: scale(0.96) translateY(40px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .modal-content h2 {
      margin-bottom: 18px;
      color: #2a3d56;
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
    }
    .modal-content label {
      display: block;
      margin-bottom: 6px;
      color: #2a3d56;
      font-weight: 500;
    }
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="file"],
    .modal-content textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #e1e7f0;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 1rem;
      background: #f8f9fb;
      transition: border 0.2s;
    }
    .modal-content input[type="text"]:focus,
    .modal-content input[type="number"]:focus,
    .modal-content textarea:focus {
      border: 1.5px solid #2a3d56;
      outline: none;
      background: #fff;
    }
    .modal-content button[type="submit"] {
      width: 100%;
      background: linear-gradient(90deg,#2a3d56 70%,#1a75ff 100%);
      color: #fff;
      padding: 12px 0;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(42,61,86,0.08);
      transition: background 0.2s;
    }
    .modal-content button[type="submit"]:hover {
      background: linear-gradient(90deg,#1a75ff 70%,#2a3d56 100%);
    }
    .modal-content .close {
      position: absolute;
      top: 18px;
      right: 22px;
      font-size: 2rem;
      color: #aaa;
      cursor: pointer;
      font-weight: 400;
      transition: color 0.2s;
    }
    .modal-content .close:hover { color: #2a3d56; }
    .modal-content .current-images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .modal-content .current-images img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(42,61,86,0.06);
      border: 1.5px solid #e1e7f0;
    }
    .edit-btn {
      background: #ffd600;
      color: #333;
      border: none;
      border-radius: 6px; /* Matches .sold-btn, .delete-btn */
      padding: 8px 0;
      font-weight: 600;
      font-size: 1rem;
      margin-top: 3px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(42,61,86,0.07);
      transition: background 0.2s;
      border: 1.5px solid #ffe066;
      letter-spacing: 0.5px;
    }
    .edit-btn:hover {
      background: #ffe066;
      color: #222;
    }
    .current-images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .current-images .img-wrap {
      position: relative;
      display: inline-block;
    }
    .current-images img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(42,61,86,0.06);
      border: 1.5px solid #e1e7f0;
      display: block;
    }
    .current-images .remove-img {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      transition: background 0.2s;
      padding: 0;
    }
    .current-images .remove-img:hover {
      background: #b02a37;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
    }
    /* Modern Edit Profile Modal Styles */
    .profile-edit-modal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      transition: opacity 0.2s;
    }
    .profile-edit-content {
      background: #fff;
      margin: 60px auto;
      padding: 40px 32px 32px 32px;
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(42,61,86,0.16);
      width: 95%;
      max-width: 420px;
      max-height: 88vh;
      overflow-y: auto;
      position: relative;
      animation: modalPop 0.22s cubic-bezier(.4,2,.6,1);
    }
    .profile-edit-content h2 {
      margin-bottom: 18px;
      color: #2a3d56;
      font-size: 1.35rem;
      font-weight: 700;
      text-align: center;
    }
    .profile-edit-content label {
      display: block;
      margin-bottom: 7px;
      color: #2a3d56;
      font-weight: 500;
    }
    .profile-edit-content input[type="text"],
    .profile-edit-content input[type="email"],
    .profile-edit-content input[type="number"],
    .profile-edit-content textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1.7px solid #e1e7f0;
      border-radius: 7px;
      margin-bottom: 18px;
      font-size: 1rem;
      background: #f8f9fb;
      transition: border 0.2s;
    }
    .profile-edit-content input:focus,
    .profile-edit-content textarea:focus {
      border: 1.7px solid #1a75ff;
      outline: none;
      background: #fff;
    }
    .profile-edit-content button[type="submit"] {
      width: 100%;
      background: linear-gradient(90deg,#2a3d56 70%,#1a75ff 100%);
      color: #fff;
      padding: 12px 0;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      font-size: 1.08rem;
      cursor: pointer;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(42,61,86,0.08);
      transition: background 0.2s;
    }
    .profile-edit-content button[type="submit"]:hover {
      background: linear-gradient(90deg,#1a75ff 70%,#2a3d56 100%);
    }
    .profile-edit-content .close {
      position: absolute;
      top: 20px;
      right: 24px;
      font-size: 2rem;
      color: #aaa;
      cursor: pointer;
      font-weight: 400;
      transition: color 0.2s;
    }
    .profile-edit-content .close:hover { color: #2a3d56; }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    /* Updated Modal Button Styles */
    .modal-content button {
      background-color: #2a3d56;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .modal-content button:hover {
      background-color: #4d6a88;
    }
    
    /* Navbar styles for consistency */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2a3d56;
      padding: 15px 30px;
      /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
      border: none;
    }
    .navlogo img {
      height: 100px;
      width: 250px;
    }
    .search-container {
      flex: 1;
      display: flex;
      justify-content: center;
      margin: 0 20px;
    }
    .searchbar {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 30px;
      padding: 2px;
      width: 100%;
      max-width: 600px;
    }
    .nav-button {
      padding: 10px 25px;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      font-weight: 500;
      display: inline-block;
      color: white;
    }
    .location-button {
      background-color: #28a745 !important;
      margin-right: 10px;
    }
    @media (max-width: 768px) {
    .searchbar select {
        padding: 8px;
        font-size: 14px;
    }
}
.searchbar select {
    background: #2a3d56;
    color: white;
    border-radius: 30px 0 0 30px;
}
.searchbar select, .searchbar input, .searchbar button {
    border: none;
    padding: 10px;
}
@media (max-width: 768px) {
    .searchbar select {
        padding: 8px;
        font-size: 14px;
    }
}
select {
    word-wrap: normal;
}
button, select {
    text-transform: none;
}
button, input, optgroup, select, textarea {
    margin: 0;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
}
select {
    word-wrap: normal;
}
button, select {
    text-transform: none;
}
button, input, optgroup, select, textarea {
    margin: 0;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
}
@media (max-width: 768px) {
    .searchbar input {
        font-size: 14px;
    }
}
.searchbar input {
    width: 100%;
}
.searchbar select, .searchbar input, .searchbar button {
    border: none;
    padding: 10px;
}

@media (max-width: 768px) {
    .searchbar input {
        font-size: 14px;
    }
}
.searchbar button {
    background: #2a3d56;
    color: white;
    border-radius: 0 30px 30px 0;
}
button, select {
    text-transform: none;
}
    /* UI improvements and effects for consistency */
    .listed-item {
      box-shadow: 0 2px 8px rgba(42,61,86,0.08);
      transition: transform 0.22s cubic-bezier(.4,2,.6,1), box-shadow 0.22s cubic-bezier(.4,2,.6,1);
      background: linear-gradient(90deg, #f4f6f9 80%, #e8ecf4 100%);
      border: 1.5px solid #e1e7f0;
    }
    .listed-item:hover {
      transform: scale(1.025) translateX(8px);
      box-shadow: 0 6px 20px rgba(42,61,86,0.16);
      background: linear-gradient(90deg, #e8ecf4 80%, #f4f6f9 100%);
    }
    .sold-label {
      background: #dc3545;
      color: #fff;
      font-weight: bold;
      padding: 7px 16px;
      border-radius: 16px;
      font-size: 1rem;
      letter-spacing: 1px;
      margin-left: 10px;
      box-shadow: 0 2px 8px rgba(220,53,69,0.18);
    }
    .sold-effect {
      opacity: 0.8;
      filter: grayscale(0.25) blur(0.5px);
      border-left: 4px solid #dc3545;
    }
    .item-details h3 {
      font-size: 1.18rem;
      color: #2a3d56;
      margin-bottom: 3px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .item-details p {
      font-size: 1.02rem;
      color: #1a75ff;
      margin-bottom: 0;
      font-weight: 500;
    }
    .item-image {
      border: 2px solid #e1e7f0;
      box-shadow: 0 2px 8px rgba(42,61,86,0.04);
      transition: box-shadow 0.22s cubic-bezier(.4,2,.6,1);
    }
    .listed-item:hover .item-image {
      box-shadow: 0 6px 20px rgba(42,61,86,0.10);
      border-color: #b3c6e0;
    }
    .sold-effect .item-image {
      border-color: #dc3545;
    }
    .sold-btn, .delete-btn {
      font-size: 1rem;
      border-radius: 24px;
      padding: 8px 18px;
      margin-left: 2px;
      margin-right: 2px;
      box-shadow: 0 2px 8px rgba(42,61,86,0.10);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .sold-btn:hover {
      background: #1a75ff !important;
      color: #fff;
      box-shadow: 0 4px 16px rgba(26,117,255,0.16);
    }
    .delete-btn:hover {
      background: #ff1744 !important;
      color: #fff;
      box-shadow: 0 4px 16px rgba(255,23,68,0.16);
    }
    /* Consistent section spacing */
    .account-container > div, .account-details > div {
      margin-bottom: 34px !important;
    }
    /* Responsive tweaks */
    @media (max-width: 600px) {
      .listed-item { flex-direction: column; align-items: flex-start; }
      .item-image { width: 96vw; max-width: 330px; height: 180px; margin-bottom: 10px; }
      .item-details { width: 100%; }
      .item-actions { width: 100%; justify-content: flex-end; }
    }
    .sold-label {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border-radius: 20px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sold-effect {
      position: relative;
      opacity: 0.85;
    }
    .sold-effect::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(40, 167, 69, 0.1);
      border-radius: 12px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Common Navbar -->
  <header>
    <div class="navbar">
        <div class="navlogo">
            <a href="index.html"><img src="Logo1.png" alt="StudXchange"></a>
        </div>
        <div class="search-container">
            <form class="searchbar" action="search-results.html" method="GET">
                <select name="category">
                    <option value="all">All</option>
                    <option value="VIT">VIT</option>
                    <option value="COEP">COEP</option>
                    <option value="PICT">PICT</option>
                    <option value="DYP">DYP</option>
                    <option value="PCCOE">PCCOE</option>
                </select>
                <input type="text" name="query" placeholder="Search products...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <button class="nav-button location-button" id="locationButton">
            <i class="fas fa-map-marker-alt"></i> 
            <span id="locationText">Get Location</span>
        </button>
        <span id="locationStatus" class="location-status"></span>
        <div class="button-container" style="display: flex;">
            <a class="nav-button wishlist-button me-2" href="wishlist.html">
                <i class="far fa-heart"></i>
            </a>
            <a class="nav-button sell-button" href="sell.html">Sell/Donate</a>
        </div>
    </div>

  <div class="account-container">
      <header class="account-header">
          <h1 style="color: white;">Welcome, <span id="userName" style="color: white;"></span></h1>
          <div class="account-actions">
              <button onclick="openEditProfileModal()">Edit Profile</button>
              <button onclick="logout()">Logout</button>
          </div>
      </header>
      <div class="account-details">
          <div class="profile-info">
              <h2 style="color: #000;">Profile Information</h2>
              <div class="profile-item" style="color: #000;">
                  <strong>Name:</strong> <span id="profileName" style="color: #000;"></span>
              </div>
              <div class="profile-item" style="color: #000;">
                  <strong>Email:</strong> <span id="profileEmail" style="color: #000;"></span>
              </div>
              <div class="profile-item" style="color: #000;">
                  <strong>Phone:</strong> 
                  <span id="profilePhone" style="color: #000;"></span>
                  <button id="addPhoneBtn" class="phone-button" onclick="openPhoneModal()">Add Phone Number</button>
              </div>
          </div>
          <div class="listed-items">
              <h2>My Listed Items</h2>
              <ul id="listedItemsList"></ul>
              
              <h3>My Notes</h3>
              <ul id="listedNotesList"></ul>

<!-- Edit Note Modal -->
<div id="editNoteModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditNoteModal()">&times;</span>
    <h2>Edit Note</h2>
    <form id="editNoteForm">
      <input type="hidden" id="editNoteId">
      <label for="editNoteTitle">Title:</label>
      <input type="text" id="editNoteTitle" required>
      <label for="editNoteSubject">Subject:</label>
      <input type="text" id="editNoteSubject" required>
      <label for="editNoteDescription">Description:</label>
      <textarea id="editNoteDescription" rows="3"></textarea>
      <label>Current Image:</label>
      <div class="current-images" id="currentNoteImage"></div>
      <label for="editNoteImage">Change Image:</label>
      <input type="file" id="editNoteImage" accept="image/*">
      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>
              
              <h3>My Room Listings</h3>
              <ul id="listedRoomsList"></ul>

<!-- Edit Room Modal -->
<div id="editRoomModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditRoomModal()">&times;</span>
    <h2>Edit Room Listing</h2>
    <form id="editRoomForm">
      <input type="hidden" id="editRoomId">
      <label for="editRoomTitle">Title:</label>
      <input type="text" id="editRoomTitle" required>
      <label for="editRoomRent">Rent/Month:</label>
      <input type="number" id="editRoomRent" required>
      <label for="editRoomDescription">Description:</label>
      <textarea id="editRoomDescription" rows="3"></textarea>
      <label>Current Images:</label>
      <div class="current-images" id="currentRoomImages"></div>
      <label for="editRoomImages">Change Images:</label>
      <input type="file" id="editRoomImages" accept="image/*" multiple>
      <button type="submit">Save Changes</button>
    </form>
  </div>
</div>
          </div>
          
          <div class="sold-items">
              <h2>Sold Items</h2>
              <ul id="soldItemsList"></ul>
          </div>
      </div>
  </div>

  <!-- Phone Modal -->
  <div id="phoneModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closePhoneModal()">&times;</span>
          <h2>Enter Phone Number</h2>
          <input type="tel" id="newPhone" placeholder="Enter 10-digit number" pattern="[0-9]{10}" required>
          <button onclick="savePhone()">Save</button>
      </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditProfileModal()">&times;</span>
      <h2>Edit Profile</h2>
      <form id="editProfileForm">
        <label for="editName">Name:</label>
        <input type="text" id="editName" name="editName" required><br><br>
        <label for="editPhone">Phone:</label>
        <input type="tel" id="editPhone" name="editPhone" pattern="[0-9]{10}" required><br><br>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Load all types of listings
      if (typeof loadListedItems === 'function') loadListedItems();
      if (typeof loadSoldItems === 'function') loadSoldItems();
      if (typeof loadNotes === 'function') loadNotes();
      if (typeof loadRooms === 'function') loadRooms();
      // Wait for Supabase and env.js to be loaded
      function waitForSupabase() {
        return new Promise(resolve => {
          if (window.supabaseClient) return resolve(window.supabaseClient);
          const check = () => {
            if (window.supabaseClient) return resolve(window.supabaseClient);
            setTimeout(check, 100);
          };
          check();
        });
      }
      const supabase = await waitForSupabase();

      // Get current session
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        localStorage.removeItem('isLoggedIn');
        showLoginRequiredDialog();
        return;
      }
      
      const user = session.user;
      // console.log('Auth user data:', user);
      
      // Set default values
      let name = 'User';
      let email = 'Not provided';
      let phone = 'Not provided';
      let userId = user.id;
      
      // Try to get email from auth
      if (user.email) {
        email = user.email;
      }
      
      // Try to get name from metadata
      if (user.user_metadata && user.user_metadata.name) {
        name = user.user_metadata.name;
      } else if (user.user_metadata && user.user_metadata.full_name) {
        name = user.user_metadata.full_name;
      }
      
      // Try to fetch additional info from users table
      try {
        const { data: profile, error } = await supabase
          .from('users')
          .select('*')
          .eq('email', email)
          .single();
          
        // console.log('Found user profile:', profile, 'Error:', error);
        
        if (profile) {
          // Update with database values if available
          if (profile.name) name = profile.name;
          if (profile.phone) phone = profile.phone;
          if (profile.id) {
            userId = profile.id;
            // 
            // console.log('Using database ID instead of auth ID:', userId);
          }
        }
      } catch (err) {
        // 
        // console.warn('Error fetching user profile:', err);
      }
      
      // Store user data
      const userData = { name, email, phone, id: userId };
      localStorage.setItem('currentUser', JSON.stringify(userData));
      window.userData = userData; // Make it globally available

      // Update DOM with user information - with extra debug logging
      // 
      // console.log('Updating profile display with:', userData);
      // console.log('DOM elements:', {
        // userName: document.getElementById('userName'),
        // profileName: document.getElementById('profileName'),
        // profileEmail: document.getElementById('profileEmail'),
        // profilePhone: document.getElementById('profilePhone')
      // });
      
      // Force update the DOM elements with a slight delay to ensure they exist
      setTimeout(() => {
        const userNameEl = document.getElementById('userName');
        const profileNameEl = document.getElementById('profileName');
        const profileEmailEl = document.getElementById('profileEmail');
        const profilePhoneEl = document.getElementById('profilePhone');
        const addPhoneBtnEl = document.getElementById('addPhoneBtn');
        
        if (userNameEl) userNameEl.textContent = name;
        if (profileNameEl) profileNameEl.textContent = name;
        if (profileEmailEl) profileEmailEl.textContent = email;
        if (profilePhoneEl) profilePhoneEl.textContent = phone;
        
        // Show/hide add phone button
        if (addPhoneBtnEl) {
          if (phone && phone !== 'Not provided') {
            addPhoneBtnEl.style.display = 'none';
          } else {
            addPhoneBtnEl.style.display = 'inline-block';
          }
        }
        
        // 
        // console.log('Profile information updated successfully');
      }, 100);
      // Listings are loaded in the main DOMContentLoaded event
    });


    // Fetch and display products listed by the logged-in user
    async function loadListedItems() {
      try {
        document.getElementById('listedItemsList').innerHTML = '<li>Loading your items...</li>';
        // Get current userId from localStorage
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const userId = currentUser?.id;
        if (!userId) throw new Error('User not authenticated');
        // Make sure Supabase client is initialized
        if (!window.supabaseClient) {
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          } else {
            throw new Error('Supabase client not available');
          }
        }
        // Fetch all products where seller_id = userId and not sold
        const { data: myProducts, error: fetchError } = await window.supabaseClient
          .from('products')
          .select('*')
          .eq('seller_id', userId)
          .eq('is_sold', false);
        if (fetchError) throw new Error(fetchError.message);
        if (myProducts && myProducts.length > 0) {
          renderListedItems(myProducts);
          return;
        }
        document.getElementById('listedItemsList').innerHTML = '<li>No items found in the database.</li>';
      } catch (error) {
        document.getElementById('listedItemsList').innerHTML = `<li>Failed to load your listed items: ${error.message}</li>`;
      }
    }
    
    // Helper function to render listed items
    function renderListedItems(products) {
      if (!products || products.length === 0) {
        document.getElementById('listedItemsList').innerHTML = '<li>No products found.</li>';
        return;
      }
      
      // Remove duplicates based on id
      const uniqueProducts = [];
      const ids = new Set();
      
      for (const product of products) {
        if (!ids.has(product.id)) {
          ids.add(product.id);
          uniqueProducts.push(product);
        }
      }
      
      // 
      // console.log('Rendering unique products:', uniqueProducts.length);
        
      document.getElementById('listedItemsList').innerHTML = uniqueProducts.map(product => {
        return `
          <li class="listed-item" onclick="window.location.href='product-details.html?id=${product.id}'" style="cursor: pointer;">
            <img src="${product.images?.[0] || product.image || 'placeholder.jpg'}" class="item-image" alt="${product.title || 'Product'}">
            <div class="item-details">
              <h3>${product.title || product.name || 'Untitled'}</h3>
              <p class="price">₹${product.price || '0'}</p>
              <p><small>Category: ${product.category || 'General'}</small></p>
            </div>
            <div class="item-actions" onclick="event.stopPropagation();">
              <button class="delete-btn" onclick="deleteItem('${product.id}')">Remove</button>
              <button class="sold-btn" onclick="handleSold('${product.id}')">Mark as Sold</button>
              <button class="edit-btn" onclick="openEditProductModal(event, '${product.id}')">Edit</button>
            </div>
          </li>
        `;
      }).join('');
    }

    // Fetch and display sold items for the logged-in user (Supabase version)
    async function loadSoldItems() {
      try {
        document.getElementById('soldItemsList').innerHTML = '<li>Loading your sold items...</li>';
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const userId = currentUser?.id;
        if (!userId) throw new Error('User not authenticated');
        if (!window.supabaseClient) {
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          } else {
            throw new Error('Supabase client not available');
          }
        }
        // Fetch all sold products for this user
        const { data: soldProducts, error: fetchError } = await window.supabaseClient
          .from('products')
          .select('*')
          .eq('seller_id', userId)
          .eq('is_sold', true);
        if (fetchError) throw new Error(fetchError.message);
        if (soldProducts && soldProducts.length > 0) {
          renderSoldItems(soldProducts);
          return;
        }
        document.getElementById('soldItemsList').innerHTML = '<li>No sold items found in the database.</li>';
      } catch (error) {
        document.getElementById('soldItemsList').innerHTML = `<li>Failed to load your sold items: ${error.message}</li>`;
      }
    }
    
    // Helper function to render sold items
    function renderSoldItems(soldItems) {
      if (!soldItems || soldItems.length === 0) {
        document.getElementById('soldItemsList').innerHTML = '<li>No sold items found.</li>';
        return;
      }
      
      // Remove duplicates based on id
      const uniqueSoldItems = [];
      const ids = new Set();
      
      for (const item of soldItems) {
        if (!ids.has(item.id)) {
          ids.add(item.id);
          uniqueSoldItems.push(item);
        }
      }
      
      // 
      // console.log('Rendering unique sold items:', uniqueSoldItems.length);
        
      document.getElementById('soldItemsList').innerHTML = uniqueSoldItems.map(item =>
        `<li class="listed-item sold-effect" onclick="window.location.href='product-details.html?id=${item.id}'" style="cursor: pointer;">
          <img src="${item.images?.[0] || item.image || 'placeholder.jpg'}" class="item-image" alt="${item.title || 'Product'}">
          <div class="item-details">
            <h3>${item.title || item.name || 'Untitled Product'}</h3>
            <p class="price">₹${item.price || '0'}</p>
            <p><small>Category: ${item.category || 'General'}</small></p>
          </div>
          <div class="item-actions">
            <span class="sold-label">SOLD</span>
          </div>
        </li>`
      ).join('');
    }



    async function deleteItem(productId) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        try {
            // Make sure Supabase client is initialized
            if (!window.supabaseClient) {
                if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                    // 
                    // console.log('Supabase client initialized in deleteItem');
                } else {
                    throw new Error('Supabase client not available');
                }
            }
            
            // 
            // console.log('Deleting product with ID:', productId);
            const { error } = await window.supabaseClient
                .from('products')
                .delete()
                .eq('id', productId);
                
            if (error) {
                // 
                // console.error('Error deleting product:', error);
                throw new Error(error.message);
            }
            
            // 
            // console.log('Product deleted successfully');
            await loadListedItems();
            alert('Item deleted successfully!');
        } catch (error) {
            // 
            // console.error('Delete error:', error);
            alert('Failed to delete item: ' + error.message);
        }
    }

    async function handleSold(productId) {
        if (!confirm('Mark this item as sold?')) return;
        try {
            // Make sure Supabase client is initialized
            if (!window.supabaseClient) {
                if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                    // 
                    // console.log('Supabase client initialized in handleSold');
                } else {
                    throw new Error('Supabase client not available');
                }
            }
            
            // 
            // console.log('Marking product as sold with ID:', productId);
            
            // First, get the current product to preserve all its data
            const { data: product, error: fetchError } = await window.supabaseClient
                .from('products')
                .select('*')
                .eq('id', productId)
                .single();
                
            if (fetchError) {
                // 
                // console.error('Error fetching product:', fetchError);
                throw new Error(fetchError.message);
            }
            
            if (!product) {
                throw new Error('Product not found');
            }
            
            // 
            // console.log('Found product to mark as sold:', product);
            
            // Update the product with is_sold = true
            const { error } = await window.supabaseClient
                .from('products')
                .update({ is_sold: true })
                .eq('id', productId);
                
            if (error) {
                // 
                // console.error('Error marking product as sold:', error);
                throw new Error(error.message);
            }
            
            // 
            // console.log('Product marked as sold successfully');
            await loadListedItems();
            await loadSoldItems();
            alert('Item marked as sold!');
        } catch (error) {
            // 
            // console.error('Error marking as sold:', error);
            alert('Failed to mark item as sold: ' + error.message);
        }
    }
    
    // Load notes from the database
    async function loadNotes() {
      try {
        document.getElementById('listedNotesList').innerHTML = '<li>Loading your notes...</li>';
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const userId = currentUser?.id;
        if (!userId) throw new Error('User not authenticated');
        if (!window.supabaseClient) {
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          } else {
            throw new Error('Supabase client not available');
          }
        }
        // Fetch all notes for this user
        const { data: myNotes, error: fetchError } = await window.supabaseClient
          .from('notes')
          .select('*')
          .eq('seller_id', userId);
        if (fetchError) throw new Error(fetchError.message);
        if (myNotes && myNotes.length > 0) {
          renderNotes(myNotes);
        } else {
          document.getElementById('listedNotesList').innerHTML = '<li>No notes found in the database.</li>';
        }
      } catch (error) {
        document.getElementById('listedNotesList').innerHTML = `<li>Failed to load your notes: ${error.message}</li>`;
      }
    }
    
    // Helper function to render notes
    function renderNotes(notes) {
      if (!notes || notes.length === 0) {
        document.getElementById('listedNotesList').innerHTML = '<li>No notes found.</li>';
        return;
      }
      
      // Remove duplicates based on id
      const uniqueNotes = [];
      const ids = new Set();
      
      for (const note of notes) {
        if (!ids.has(note.id)) {
          ids.add(note.id);
          uniqueNotes.push(note);
        }
      }
      
      // 
      // console.log('Rendering unique notes:', uniqueNotes.length);
        
      document.getElementById('listedNotesList').innerHTML = uniqueNotes.map(note => {
  return `
    <li class="listed-item" onclick="window.location.href='notes_interface.html?id=${note.id}'" style="cursor: pointer;">
      <img src="${note.image || 'note-placeholder.jpg'}" class="item-image" alt="${note.title || 'Note'}">
      <div class="item-details">
        <h3>${note.title || 'Untitled Note'}</h3>
        <p><small>Subject: ${note.subject || 'General'}</small></p>
      </div>
      <div class="item-actions" onclick="event.stopPropagation();">
        <button class="delete-btn" onclick="deleteNote('${note.id}')">Remove</button>
        <button class="edit-btn" onclick="openEditNoteModal(event, '${note.id}')">Edit</button>
      </div>
    </li>
  `;
}).join('');
    }
    
    // Delete a note
    async function deleteNote(noteId) {
        if (!confirm('Are you sure you want to delete this note?')) return;
        try {
            // Make sure Supabase client is initialized
            if (!window.supabaseClient) {
                if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                    // 
                    // console.log('Supabase client initialized in deleteNote');
                } else {
                    throw new Error('Supabase client not available');
                }
            }
            
            // 
            // console.log('Deleting note with ID:', noteId);
            const { error } = await window.supabaseClient
                .from('notes')
                .delete()
                .eq('id', noteId);
                
            if (error) {
                // 
                // console.error('Error deleting note:', error);
                throw new Error(error.message);
            }
            
            // 
            // console.log('Note deleted successfully');
            await loadNotes();
            alert('Note deleted successfully!');
        } catch (error) {
            // 
            // console.error('Delete error:', error);
            alert('Failed to delete note: ' + error.message);
        }
    }
    
    // Load rooms from the database
    async function loadRooms() {
      try {
        document.getElementById('listedRoomsList').innerHTML = '<li>Loading your room listings...</li>';
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const userId = currentUser?.id;
        if (!userId) throw new Error('User not authenticated');
        if (!window.supabaseClient) {
          if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          } else {
            throw new Error('Supabase client not available');
          }
        }
        // Fetch all rooms for this user
        const { data: myRooms, error: fetchError } = await window.supabaseClient
          .from('rooms')
          .select('*')
          .eq('seller_id', userId);
        if (fetchError) throw new Error(fetchError.message);
        if (myRooms && myRooms.length > 0) {
          renderRooms(myRooms);
        } else {
          document.getElementById('listedRoomsList').innerHTML = '<li>No room listings found in the database.</li>';
        }
      } catch (error) {
        document.getElementById('listedRoomsList').innerHTML = `<li>Failed to load your room listings: ${error.message}</li>`;
      }
    }
    
    // Helper function to render rooms
    function renderRooms(rooms) {
      if (!rooms || rooms.length === 0) {
        document.getElementById('listedRoomsList').innerHTML = '<li>No room listings found.</li>';
        return;
      }
      
      // Remove duplicates based on id
      const uniqueRooms = [];
      const ids = new Set();
      
      for (const room of rooms) {
        if (!ids.has(room.id)) {
          ids.add(room.id);
          uniqueRooms.push(room);
        }
      }
      
      // 
      // console.log('Rendering unique rooms:', uniqueRooms.length);
        
      document.getElementById('listedRoomsList').innerHTML = uniqueRooms.map(room => {
  return `
    <li class="listed-item" onclick="window.location.href='room-details.html?id=${room.id}'" style="cursor: pointer;">
      <img src="${room.images?.[0] || room.image || 'room-placeholder.jpg'}" class="item-image" alt="${room.title || 'Room'}">
      <div class="item-details">
        <h3>${room.title || 'Room for Rent'}</h3>
        <p class="price">₹${room.rent || room.price || '0'}/month</p>
      </div>
      <div class="item-actions" onclick="event.stopPropagation();">
        <button class="delete-btn" onclick="deleteRoom('${room.id}')">Remove</button>
        <button class="edit-btn" onclick="openEditRoomModal(event, '${room.id}')">Edit</button>
      </div>
    </li>
  `;
}).join('');
    }
    
    // Delete a room listing
    async function deleteRoom(roomId) {
        if (!confirm('Are you sure you want to delete this room listing?')) return;
        try {
            // Make sure Supabase client is initialized
            if (!window.supabaseClient) {
                if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                    // 
                    // console.log('Supabase client initialized in deleteRoom');
                } else {
                    throw new Error('Supabase client not available');
                }
            }
            
            // 
            // console.log('Deleting room with ID:', roomId);
            const { error } = await window.supabaseClient
                .from('rooms')
                .delete()
                .eq('id', roomId);
                
            if (error) {
                // 
                // console.error('Error deleting room:', error);
                throw new Error(error.message);
            }
            
            // 
            // console.log('Room listing deleted successfully');
            await loadRooms();
            alert('Room listing deleted successfully!');
        } catch (error) {
            // 
            // console.error('Delete error:', error);
            alert('Failed to delete room listing: ' + error.message);
        }
    }

    function openEditProfileModal() {
      const user = JSON.parse(localStorage.getItem('currentUser'));
      document.getElementById('editName').value = user.name || '';
      document.getElementById('editPhone').value = user.phone || '';
      document.getElementById('editProfileModal').style.display = 'block';
    }
    function closeEditProfileModal() {
      document.getElementById('editProfileModal').style.display = 'none';
    }

    // Open and close phone modal
    function openPhoneModal() {
      document.getElementById('phoneModal').style.display = 'block';
      document.getElementById('newPhone').value = '';
    }
    function closePhoneModal() {
      document.getElementById('phoneModal').style.display = 'none';
    }

    // Save phone number to users table in Supabase
    async function savePhone() {
      // Determine which modal is open
      const phoneModal = document.getElementById('phoneModal');
      const editProfileModal = document.getElementById('editProfileModal');
      let newPhone = '';
      let isPhoneModal = false;
      if (phoneModal && phoneModal.style.display === 'block') {
        newPhone = document.getElementById('newPhone').value.trim();
        isPhoneModal = true;
      } else if (editProfileModal && editProfileModal.style.display === 'block') {
        newPhone = document.getElementById('editPhone').value.trim();
      }
      if (!newPhone.match(/^\d{10}$/)) {
        alert('Please enter a valid 10-digit phone number');
        return;
      }
      try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        // Update user in Supabase users table
        const { data, error } = await window.supabaseClient
          .from('users')
          .update({ phone: newPhone })
          .eq('id', currentUser.id);
        if (error) throw new Error('Failed to update phone: ' + error.message);
        // Update localStorage and UI
        currentUser.phone = newPhone;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        document.getElementById('profilePhone').textContent = newPhone;
        document.getElementById('addPhoneBtn').style.display = 'none';
        if (isPhoneModal) {
          closePhoneModal();
        } else {
          closeEditProfileModal();
        }
        alert('Phone number updated!');
      } catch (error) {
        // 
        // console.error('Error saving phone:', error);
        alert('Failed to save phone number');
      }
    }

    document.getElementById('editProfileForm').onsubmit = async function(e) {
      e.preventDefault();
      const newName = document.getElementById('editName').value.trim();
      await savePhone();
      // Update name in UI
      document.getElementById('profileName').textContent = newName;
      closeEditProfileModal();
      alert('Profile updated successfully!');
    };

    // Other account actions
    async function logout() {
  // Ensure Supabase client is initialized
  if (!window.supabaseClient) {
    if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    }
  }
  try {
    await window.supabaseClient.auth.signOut();
  } catch (e) {
    // ignore
  }
  // Remove all user/session data
  localStorage.removeItem('currentUser');
  localStorage.removeItem('isLoggedIn');
  sessionStorage.clear();
  // Optionally clear cookies if any custom auth
  // Redirect to login page
  window.location.href = 'login.html';
}

    function showLoginRequiredDialog() {
  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100vw';
  overlay.style.height = '100vh';
  overlay.style.background = 'rgba(0,0,0,0.4)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';

  // Create dialog box
  const dialog = document.createElement('div');
  dialog.style.background = '#fff';
  dialog.style.padding = '32px 24px';
  dialog.style.borderRadius = '12px';
  dialog.style.boxShadow = '0 4px 24px rgba(0,0,0,0.15)';
  dialog.style.textAlign = 'center';
  dialog.innerHTML = `<div style="font-size:1.2rem;margin-bottom:12px;">You must be logged in to access this page.</div><button id="closeProfileLoginDialog" style="padding:8px 20px;background:#2a3d56;color:#fff;border:none;border-radius:6px;font-size:1rem;cursor:pointer;">Close</button>`;

  overlay.appendChild(dialog);
  document.body.appendChild(overlay);
  document.getElementById('closeProfileLoginDialog').onclick = function() {
    document.body.removeChild(overlay);
  };
}
// Sync login state for sell.html if redirected
    document.addEventListener('DOMContentLoaded', async function() {
      // Load all types of listings
      if (typeof loadListedItems === 'function') loadListedItems();
      if (typeof loadSoldItems === 'function') loadSoldItems();
      if (typeof loadNotes === 'function') loadNotes();
      if (typeof loadRooms === 'function') loadRooms();
      const urlParams = new URLSearchParams(window.location.search);
      const fromSell = urlParams.get('from') === 'sell';
      let userData = null;
      let session = null;
      try {
        userData = JSON.parse(localStorage.getItem('currentUser'));
      } catch {}
      if ((!userData || !userData.id) && window.supabaseClient) {
        const { data } = await window.supabaseClient.auth.getSession();
        session = data.session;
        if (session && session.user) {  
          userData = { id: session.user.id, email: session.user.email, ...session.user.user_metadata };
          localStorage.setItem('currentUser', JSON.stringify(userData));
        }
      }
      if (fromSell) {
        if (userData && userData.id) {
          // If coming from sell.html, sync state and go back
          window.location.href = 'sell.html';
          return;
        } else {
          // Show message and redirect to login
          document.body.innerHTML = '<div style="padding:40px;text-align:center;font-size:1.3rem;color:#b00;">You must be logged in to sell. Redirecting to login...</div>';
          setTimeout(function() { window.location.href = "login.html"; }, 2000);
          return;
        }
      }
      {
        let userData = null;
        try {
          userData = JSON.parse(localStorage.getItem('currentUser'));
        } catch (e) {}
        if (userData && userData.name && userData.email) {
          document.getElementById('userName').innerText = userData.name;
          document.getElementById('profileName').innerText = userData.name;
          document.getElementById('profileEmail').innerText = userData.email;
        } else {
          // fallback: fetch from Supabase if logged in
          if (!window.supabaseClient) {
            const supabaseLib = window.supabase || (typeof globalThis !== 'undefined' ? globalThis.supabase : undefined);
            if (supabaseLib && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
              window.supabaseClient = supabaseLib.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            }
          }
          const supabase = window.supabaseClient;
          let { data: { user } } = await supabase.auth.getUser();
          if (user) {
            let { data: profile, error } = await supabase
              .from('users')
              .select('name, email')
              .eq('id', user.id)
              .single();
            if (profile) {
              document.getElementById('userName').innerText = profile.name;
              document.getElementById('profileName').innerText = profile.name;
              document.getElementById('profileEmail').innerText = profile.email;
              localStorage.setItem('currentUser', JSON.stringify(profile));
            }
          }
        }
      }
    });
  </script>
<!-- Edit Product Modal -->
<div id="editProductModal" class="modal" style="z-index:10000;">
  <div class="modal-content" style="max-height:80vh; overflow-y:auto; width:95%; max-width:500px;">
    <span class="close" onclick="closeEditProductModal()">&times;</span>
    <h2>Edit Product</h2>
    <form id="editProductForm">
      <input type="hidden" id="editProductId" name="id">
      <div style="margin-bottom:12px;">
        <label for="editProductTitle">Title:</label>
        <input type="text" id="editProductTitle" name="title" required style="width:100%;">
      </div>
      <div style="margin-bottom:12px;">
        <label for="editProductPrice">Price:</label>
        <input type="number" id="editProductPrice" name="price" required style="width:100%;">
      </div>
      <div style="margin-bottom:12px;">
        <label for="editProductCategory">Category:</label>
        <input type="text" id="editProductCategory" name="category" required style="width:100%;">
      </div>
      <div style="margin-bottom:12px;">
        <label for="editProductDescription">Description:</label>
        <textarea id="editProductDescription" name="description" rows="3" style="width:100%;"></textarea>
      </div>
      <div style="margin-bottom:12px;">
        <label>Current Images:</label>
        <div id="currentProductImages" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;"></div>
        <label for="editProductImages">Change Images:</label>
        <input type="file" id="editProductImages" name="images" accept="image/*" multiple style="width:100%;">
      </div>
      <button type="submit" style="width:100%;background:#2a3d56;color:white;padding:10px 0;border-radius:6px;">Save Changes</button>
    </form>
  </div>
</div>

<script>
// Open edit modal and populate form
function openEditProductModal(e, productId) {
  e.stopPropagation();
  document.getElementById('editProductModal').style.display = 'block';
  // Clear previous images
  document.getElementById('currentProductImages').innerHTML = '';
  // Fetch product info from Supabase
  if (!window.supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  }
  window.supabaseClient
    .from('products')
    .select('*')
    .eq('id', productId)
    .single()
    .then(({ data: product, error }) => {
      if (error || !product) {
        alert('Failed to fetch product info.');
        closeEditProductModal();
        return;
      }
      document.getElementById('editProductId').value = product.id;
      document.getElementById('editProductTitle').value = product.title || '';
      document.getElementById('editProductPrice').value = product.price || '';
      document.getElementById('editProductCategory').value = product.category || '';
      document.getElementById('editProductDescription').value = product.description || '';
      // Show current images
      const imgDiv = document.getElementById('currentProductImages');
      imgDiv.innerHTML = '';
      let images = product.images || product.image || [];
      if (typeof images === 'string') {
        try { images = JSON.parse(images); } catch { images = [images]; }
      }
      if (!Array.isArray(images)) images = [images];
      images.forEach((src, idx) => {
        if (src) {
          const wrap = document.createElement('div');
          wrap.className = 'img-wrap';
          const img = document.createElement('img');
          img.src = src;
          img.setAttribute('data-idx', idx);
          const btn = document.createElement('button');
          btn.className = 'remove-img';
          btn.type = 'button';
          btn.innerHTML = '&times;';
          btn.onclick = function(ev) {
            ev.stopPropagation();
            img.parentNode.remove();
          };
          wrap.appendChild(img);
          wrap.appendChild(btn);
          imgDiv.appendChild(wrap);
        }
      });
    });
}
function closeEditProductModal() {
  document.getElementById('editProductModal').style.display = 'none';
}
// Handle form submit
const editProductForm = document.getElementById('editProductForm');
if (editProductForm) {
  editProductForm.onsubmit = async function(e) {
    e.preventDefault();
    const productId = document.getElementById('editProductId').value;
    const title = document.getElementById('editProductTitle').value.trim();
    const price = parseFloat(document.getElementById('editProductPrice').value);
    const category = document.getElementById('editProductCategory').value.trim();
    const description = document.getElementById('editProductDescription').value.trim();
    const imagesInput = document.getElementById('editProductImages');
    let imageUrls = [];
    // If new images selected, upload to Supabase Storage (assumes 'product-images' bucket)
    if (imagesInput.files && imagesInput.files.length > 0) {
      imageUrls = [];
      for (let i = 0; i < imagesInput.files.length; i++) {
        const file = imagesInput.files[i];
        const fileName = `${productId}_${Date.now()}_${file.name}`;
        const { data, error } = await window.supabaseClient.storage.from('product-images').upload(fileName, file, { upsert: true });
        if (error) {
          alert('Failed to upload image: ' + error.message);
          return;
        }
        const { data: { publicUrl } } = window.supabaseClient.storage.from('product-images').getPublicUrl(fileName);
        imageUrls.push(publicUrl);
      }
    } else {
      // Use current images if no new ones selected
      const imgDiv = document.getElementById('currentProductImages');
      imageUrls = Array.from(imgDiv.querySelectorAll('img')).map(img => img.src);
    }
    // Update product in Supabase
    const updates = {
      title,
      price,
      category,
      description,
      images: imageUrls
    };
    const { error } = await window.supabaseClient
      .from('products')
      .update(updates)
      .eq('id', productId);
    if (error) {
      alert('Failed to update product: ' + error.message);
      return;
    }
    alert('Product updated successfully!');
    closeEditProductModal();
    if (typeof loadListedItems === 'function') loadListedItems();
  };
}
// -------- Edit Note Modal Logic --------
function openEditNoteModal(e, noteId) {
  e.stopPropagation();
  document.getElementById('editNoteModal').style.display = 'block';
  document.getElementById('currentNoteImage').innerHTML = '';
  if (!window.supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  }
  window.supabaseClient
    .from('notes')
    .select('*')
    .eq('id', noteId)
    .single()
    .then(({ data: note, error }) => {
      if (error || !note) {
        alert('Failed to fetch note info.');
        closeEditNoteModal();
        return;
      }
      document.getElementById('editNoteId').value = note.id;
      document.getElementById('editNoteTitle').value = note.title || '';
      document.getElementById('editNoteSubject').value = note.subject || '';
      document.getElementById('editNoteDescription').value = note.description || '';
      // Show current image
      const imgDiv = document.getElementById('currentNoteImage');
      imgDiv.innerHTML = '';
      let image = note.image || '';
      if (image) {
        const wrap = document.createElement('div');
        wrap.className = 'img-wrap';
        const img = document.createElement('img');
        img.src = image;
        img.setAttribute('data-idx', 0);
        const btn = document.createElement('button');
        btn.className = 'remove-img';
        btn.type = 'button';
        btn.innerHTML = '&times;';
        btn.onclick = function(ev) {
          ev.stopPropagation();
          img.parentNode.remove();
        };
        wrap.appendChild(img);
        wrap.appendChild(btn);
        imgDiv.appendChild(wrap);
      }
    });
}
function closeEditNoteModal() {
  document.getElementById('editNoteModal').style.display = 'none';
}
const editNoteForm = document.getElementById('editNoteForm');
if (editNoteForm) {
  editNoteForm.onsubmit = async function(e) {
    e.preventDefault();
    const noteId = document.getElementById('editNoteId').value;
    const title = document.getElementById('editNoteTitle').value.trim();
    const subject = document.getElementById('editNoteSubject').value.trim();
    const description = document.getElementById('editNoteDescription').value.trim();
    const imageInput = document.getElementById('editNoteImage');
    let imageUrl = '';
    if (imageInput.files && imageInput.files.length > 0) {
      const file = imageInput.files[0];
      const fileName = `${noteId}_${Date.now()}_${file.name}`;
      const { data, error } = await window.supabaseClient.storage.from('note-images').upload(fileName, file, { upsert: true });
      if (error) {
        alert('Failed to upload image: ' + error.message);
        return;
      }
      const { data: { publicUrl } } = window.supabaseClient.storage.from('note-images').getPublicUrl(fileName);
      imageUrl = publicUrl;
    } else {
      // Use current image if no new one selected
      const imgDiv = document.getElementById('currentNoteImage');
      const img = imgDiv.querySelector('img');
      imageUrl = img ? img.src : '';
    }
    const updates = {
      title,
      subject,
      description,
      image: imageUrl
    };
    const { error } = await window.supabaseClient
      .from('notes')
      .update(updates)
      .eq('id', noteId);
    if (error) {
      alert('Failed to update note: ' + error.message);
      return;
    }
    alert('Note updated successfully!');
    closeEditNoteModal();
    if (typeof loadNotes === 'function') loadNotes();
  };
}
// -------- Edit Room Modal Logic --------
function openEditRoomModal(e, roomId) {
  e.stopPropagation();
  document.getElementById('editRoomModal').style.display = 'block';
  document.getElementById('currentRoomImages').innerHTML = '';
  if (!window.supabaseClient && window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
    window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  }
  window.supabaseClient
    .from('rooms')
    .select('*')
    .eq('id', roomId)
    .single()
    .then(({ data: room, error }) => {
      if (error || !room) {
        alert('Failed to fetch room info.');
        closeEditRoomModal();
        return;
      }
      document.getElementById('editRoomId').value = room.id;
      document.getElementById('editRoomTitle').value = room.title || '';
      document.getElementById('editRoomRent').value = room.rent || room.price || '';
      document.getElementById('editRoomDescription').value = room.description || '';
      // Show current images
      const imgDiv = document.getElementById('currentRoomImages');
      imgDiv.innerHTML = '';
      let images = room.images || room.image || [];
      if (typeof images === 'string') {
        try { images = JSON.parse(images); } catch { images = [images]; }
      }
      if (!Array.isArray(images)) images = [images];
      images.forEach((src, idx) => {
        if (src) {
          const wrap = document.createElement('div');
          wrap.className = 'img-wrap';
          const img = document.createElement('img');
          img.src = src;
          img.setAttribute('data-idx', idx);
          const btn = document.createElement('button');
          btn.className = 'remove-img';
          btn.type = 'button';
          btn.innerHTML = '&times;';
          btn.onclick = function(ev) {
            ev.stopPropagation();
            img.parentNode.remove();
          };
          wrap.appendChild(img);
          wrap.appendChild(btn);
          imgDiv.appendChild(wrap);
        }
      });
    });
}
function closeEditRoomModal() {
  document.getElementById('editRoomModal').style.display = 'none';
}
const editRoomForm = document.getElementById('editRoomForm');
if (editRoomForm) {
  editRoomForm.onsubmit = async function(e) {
    e.preventDefault();
    const roomId = document.getElementById('editRoomId').value;
    const title = document.getElementById('editRoomTitle').value.trim();
    const rent = parseFloat(document.getElementById('editRoomRent').value);
    const description = document.getElementById('editRoomDescription').value.trim();
    const imagesInput = document.getElementById('editRoomImages');
    let imageUrls = [];
    if (imagesInput.files && imagesInput.files.length > 0) {
      imageUrls = [];
      for (let i = 0; i < imagesInput.files.length; i++) {
        const file = imagesInput.files[i];
        const fileName = `${roomId}_${Date.now()}_${file.name}`;
        const { data, error } = await window.supabaseClient.storage.from('room-images').upload(fileName, file, { upsert: true });
        if (error) {
          alert('Failed to upload image: ' + error.message);
          return;
        }
        const { data: { publicUrl } } = window.supabaseClient.storage.from('room-images').getPublicUrl(fileName);
        imageUrls.push(publicUrl);
      }
    } else {
      // Use current images if no new ones selected
      const imgDiv = document.getElementById('currentRoomImages');
      imageUrls = Array.from(imgDiv.querySelectorAll('img')).map(img => img.src);
    }
    const updates = {
      title,
      rent,
      images: imageUrls,
      description
    };
    const { error } = await window.supabaseClient
      .from('rooms')
      .update(updates)
      .eq('id', roomId);
    if (error) {
      alert('Failed to update room: ' + error.message);
      return;
    }
    alert('Room updated successfully!');
    closeEditRoomModal();
    if (typeof loadRooms === 'function') loadRooms();
  };
}
</script>
</body>
</html>
